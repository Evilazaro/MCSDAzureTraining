<p><a name="HOLTop" /></p>

<h1>Deploying Cloud Services in Windows Azure</h1>

<hr>

<p><a name="Overview" /></p>

<h2>Overview</h2>

<p>In this hands-on lab, you will learn how to deploy your first application in Windows Azure. The lab walks through the process using myTODO, a simple list creation and management application built using ASP.NET MVC. The lab shows the steps required for provisioning the required components in the Windows Azure Management Portal, uploading the service package, and configuring the cloud service. You will see how you can test your application in a staging environment and then promote it to production once you are satisfied that it is operating according to your expectations.</p>

<p><img src="Images/mytodo.png?raw=true" alt="The myTODO application running in Windows Azure">
</p>

<p><em>The myTODO application running in Windows Azure</em></p>

<p>In the course of the lab, you will also examine how to deploy, upgrade, and configure Windows Azure applications programmatically using the Service Management API. You will use the Windows Azure Service Management Tools, which wraps the management API, to execute Windows PowerShell scripts that perform these operations. To complete the examination of deployment choices, you will use the Windows Azure Tools to deploy the application directly from Visual Studio.</p>

<p>During the lab, you will also learn how to provide an SSL connection to your Windows Azure service.</p>

<p><a name="Objectives" /></p>

<h3>Objectives</h3>

<p>In this hands-on lab, you will learn how to:</p>

<ul>
<li>Use the Windows Azure Management Portal to create a storage account and a cloud service</li>
<li>Deploy service component packages using the Windows Azure Management Portal user interface</li>
<li>Change configuration settings for a deployed application</li>
<li>Test deployments in a separate staging environment before deployment to final production</li>
<li>Use Windows PowerShell to deploy, upgrade, and configure Windows Azure services programmatically</li>
<li>Use the Windows Azure Tools for publishing from Visual Studio</li>
<li>Secure your Windows Azure application with SSL</li>
</ul>

<p><a name="Prerequisites" /></p>

<h3>Prerequisites</h3>

<p>The following is required to complete this hands-on lab:</p>

<ul>
<li><p><a href="http://www.microsoft.com/visualstudio/">Visual Studio Express 2013 for Web</a> or greater</p></li>
<li><p><a href="http://www.microsoft.com/windowsazure/sdk/">Windows Azure Tools for Microsoft Visual Studio 2.2</a> or later</p></li>
<li><p><a href="http://msdn.microsoft.com/en-us/library/windowsazure/jj156055">Windows Azure PowerShell Cmdlets</a></p></li>
<li><p>A Windows Azure subscription</p>

<ul>
<li>Sign up for a <a href="http://aka.ms/watk-freetrial">Free Trial</a></li>
<li>If you are a Visual Studio Professional, Test Professional, Premium or Ultimate with MSDN or MSDN Platforms subscriber, activate your <a href="http://aka.ms/watk-msdn">MSDN benefit</a> now to start developing and testing on Windows Azure.</li>
<li><a href="http://aka.ms/watk-bizspark">BizSpark</a> members automatically receive the Windows Azure benefit through their Visual Studio Ultimate with MSDN subscriptions.</li>
<li>Members of the <a href="http://aka.ms/watk-mpn">Microsoft Partner Network</a> Cloud Essentials program receive monthly Windows Azure credits at no charge.</li>
</ul></li>
</ul>
<blockquote>
<p><strong>Note:</strong> This lab was designed for Windows 8.1.</p>

<p>When you first start Visual Studio, you must select one of the predefined settings collections. Every predefined collection is designed to match a particular development style and determines window layouts, editor behavior, IntelliSense code snippets, and dialog box options. The procedures in this lab describe the actions necessary to accomplish a given task in Visual Studio when using the <strong>General Development Settings</strong> collection. If you choose a different settings collection for your development environment, there may be differences in these procedures that you need to take into account.</p>
</blockquote>
<hr>

<p><a name="Exercises" /></p>

<h2>Exercises</h2>

<p>This hands-on lab includes the following exercises:</p>

<ol>
<li><a href="#Exercise1">Deploying an Application Using the Windows Azure Management Portal</a></li>
<li><a href="#Exercise2">Using PowerShell to Manage Windows Azure Applications</a></li>
<li><a href="#Exercise3">Using Visual Studio to Publish Applications</a></li>
<li><a href="#Exercise4">Securing Windows Azure with SSL</a></li>
</ol>

<p>Estimated time to complete this lab: <strong>90 minutes</strong>.</p>
<blockquote>
<p><strong>Note:</strong> Each exercise is accompanied by a starting solution located in the Begin folder of the exercise that allows you to follow each exercise independently of the others. Please be aware that the code snippets that are added during an exercise are missing from these starting solutions and that they will not necessarily work until you complete the exercise. Inside the source code for an exercise, you will also find an End folder containing a Visual Studio solution with the code that results from completing the steps in the corresponding exercise. You can use these solutions as guidance if you need additional help as you work through this hands-on lab.</p>
</blockquote>
<hr>

<p><a name="Exercise1" /></p>

<h3>Exercise 1: Deploying an application using the Windows Azure Management Portal</h3>

<p>In this exercise, you deploy the myTODO application to Windows Azure using the Windows Azure Management Portal. To do this, you will provision the required service components at the management portal, upload the application package to the staging environment and configure it. You will then execute the application in this test environment to verify its operation. Once you are satisfied that it operates according to your expectations, you will promote the application to production.</p>

<p><a name="Ex1Task1" /></p>

<h4>Task 1 - Creating a Storage Account, a Cloud Service and a SQL Database</h4>

<p>The application you deploy in this exercise requires a Cloud Service, a SQL Database and a Storage Account. In this task, you will create a new SQL Database  to allow the application to persist its data. In addition, you will define a Cloud Service to host your web application, and a Storage Account to store the diagnostic data collected by the application.</p>

<ol>
<li><p>Navigate to <a href="http://manage.windowsazure.com"><a href="http://manage.windowsazure.com">http://manage.windowsazure.com</a></a> using a Web browser and sign in using the Microsoft Account associated with your Windows Azure account.</p>

<p><img src="Images/signing-in-to-the-windows-azure-management-po.png?raw=true" alt="Signing in to the Windows Azure Management portal">
</p>

<p><em>Signing in to the Windows Azure Management portal</em></p></li>
<li><p>First, create an <strong>Affinity Group</strong> where your services will be deployed. In the Windows Azure Management Portal menu, click <strong>Settings</strong>.</p>

<p><img src="Images/select-settings.png?raw=true" alt="Select Settings">
</p>

<p><em>Select Settings</em></p></li>
<li><p>In the <strong>Settings</strong> page, click <strong>Affinity Groups</strong>.</p>

<p><img src="Images/settings-page.png?raw=true" alt="Settings page">
</p>

<p><em>Settings page</em></p></li>
<li><p>Click <strong>Add</strong> button in order to create a new <strong>Affinity Group</strong>.</p>

<p><img src="Images/add-affinity-group.png?raw=true" alt="Add Affinity Group">
</p>

<p><em>Add Affinity Group</em></p></li>
<li><p>In the <strong>Create Affinity Group</strong> dialog box, enter a <strong>Name</strong> (e.g. <em>MyAffinityGroup</em>) a <strong>Description</strong> and the <strong>Region</strong> for your new group. Click the <strong>Tick</strong> button to continue.</p>

<p><img src="Images/affinity-group-details.png?raw=true" alt="Affinity Group details">
</p>

<p><em>Affinity Group details</em></p>
<blockquote>
<p><strong>Note:</strong> The reason that you are creating a new affinity group is to deploy both the cloud service and storage account to the same location, thus ensuring high bandwidth and low latency between the application and the data it depends on.</p>
</blockquote></li>
<li><p>Now, you will create the <strong>Storage Account</strong> that the application will use to store the diagnostic data. In the Windows Azure Management Portal, click <strong>New</strong> | <strong>Data Services</strong> | <strong>Storage</strong> | <strong>Quick Create</strong>.</p></li>
<li><p>Set a unique <strong>URL</strong>  (e.g. <em>storagemytodo</em>) and select the <em>Affinity Group</em> you previously created. Click <strong>Create Storage Account</strong> button to continue.</p>

<p><img src="Images/creating-a-new-storage-account.png?raw=true" alt="Creating a new storage account">
</p>

<p><em>Creating a new storage account</em></p>
<blockquote>
<p><strong>Note:</strong> The URL used for the storage account corresponds to a DNS name and is subject to standard DNS naming rules. Moreover, the name is publicly visible and must therefore be unique. The portal ensures that the name is valid by verifying that the name complies with the naming rules and is currently available. A validation error will be shown if you enter a name that does not satisfy the rules.</p>

<p><img src="./Images/url-validation.png?raw=true" alt="URL Validation">
</p>
</blockquote></li>
<li><p>Wait until the storage account is created. Select your storage account and click <strong>Manage Access Keys</strong> at the bottom of the page in order to show the storage account's access keys.</p>

<p><img src="Images/manage-storage-account-keys.png?raw=true" alt="Manage Storage Account keys">
</p>

<p><em>Manage Storage Account keys</em></p></li>
<li><p>Copy the <strong>Storage account name</strong>, and the <strong>Primary access key</strong> values. You will use these values later on to configure the application.</p>

<p><img src="Images/retrieving-the-storage-access-keys.png?raw=true" alt="Retrieving the storage access keys">
</p>

<p><em>Retrieving the storage access keys</em></p>
<blockquote>
<p><strong>Note:</strong> The <strong>Primary Access Key</strong> and <strong>Secondary Access Key</strong> provide a shared secret that you can use to access storage. The secondary key gives the same access as the primary key and is used for backup purposes. You can regenerate each key independently in case either one is compromised.</p>
</blockquote></li>
<li><p>Next, create the <strong>Cloud Service</strong> that executes the application code. Click <strong>New</strong> | <strong>Compute</strong> | <strong>Cloud Service</strong> | <strong>Quick Create</strong>.</p></li>
<li><p>Select a <strong>URL</strong> for your cloud service (e.g. <em>servicemytodo</em>) and the <strong>Affinity Group</strong> where you created the storage account. Click <strong>Create Cloud Service</strong> to continue. Windows Azure uses the URL value to generate the endpoint URLs for the cloud service.</p>

<p><img src="Images/creating-a-new-cloud-service.png?raw=true" alt="Creating a new Cloud Service">
</p>

<p><em>Creating a new Cloud Service</em></p>
<blockquote>
<p><strong>Note:</strong> The portal ensures that the name is valid by verifying that the name complies with the naming rules and is currently available. A validation error will be shown if you enter name that does not satisfy the rules.</p>

<p><img src="./Images/url-prefix-validation.png?raw=true" alt="URL prefix validation">
</p>

<p>By choosing the same affinity group you used for your storage account, you ensure that the cloud service is deployed to the same data center.</p>
</blockquote></li>
<li><p>Wait until your cloud service is created to continue.</p>

<p><img src="./Images/cloud-service-created.png?raw=true" alt="Cloud Service Created" title="Cloud Service Created">
</p>

<p><em>Cloud Service Created</em></p></li>
<li><p>Finally, create the <strong>SQL Database</strong> that the application will use to store its data. Click <strong>New | Data Services | SQL Database | Quick Create</strong>. </p></li>
<li><p>Enter a <strong>Database Name</strong> (e.g. <em>dbmytodo</em>), select <strong>New SQL database server</strong> in the <strong>Server</strong> drop-down list and select the same <strong>Region</strong> specified for the affinity you created previously. Finally, Enter a <strong>Login Name</strong> (e.g. <em>SQLAdmin</em>) and a <strong>Password</strong> for the database administrator.</p>

<p><img src="Images/creating-a-sql-database.png?raw=true" alt="Creating a SQL Database">
</p></li>
<li><p>Wait until the database is created. Go to the <strong>SQL Databases</strong> page and click your database to go to the <strong>Quick Start</strong> page. Take note of the <strong>Server</strong> information under the <strong>Connect to your database</strong> section. You will use this value later on to configure the application.</p>

<p><img src="Images/sql-database-server-information.png?raw=true" alt="SQL Database server information">
</p></li>
<li><p>Do not close the browser window, you will use the portal for the next task.</p></li>
</ol>

<p><a name="Ex1Task2" /></p>

<h4>Task 2 - Publishing the Application to the Windows Azure Management Portal</h4>

<p>A Cloud Service is a service that hosts your code in the Windows Azure environment. It has two separate deployment slots: <strong>staging</strong> and <strong>production</strong>. The staging deployment slot allows you to test your service in the Windows Azure environment before you deploy it to production.</p>

<p>In this task, you will create a service package for the myTODO application and then deploy it to the staging environment using the Windows Azure Management Portal.</p>

<ol>
<li><p>Launch <strong>Microsoft Visual Studio Express 2013 for Web</strong> (or greater) as Administrator.</p></li>
<li><p>In the <strong>File</strong> menu, select <strong>Open Project</strong> and browse to <strong>Ex1-DeployingWithWAZPortal\Begin</strong> in the <strong>Source</strong> folder of the lab. Select <strong>MyTodo.sln</strong> and click <strong>Open</strong>.</p>

<p>The solution contains the following projects:</p>

<ul>
<li><strong>MyTodo</strong>. A standard cloud service project configured to support a single web role named <strong>MyTodo.WebUx</strong>.</li>
<li><strong>MyTodo.WebUx</strong>. A web role that hosts the myTODO ASP.NET MVC application in Windows Azure.</li>
</ul></li>
<li><p>Build the solution in order to download and install the NuGet package dependencies. To do this, click <strong>Build</strong> | <strong>Build Solution</strong> or press <strong>Ctrl</strong> + <strong>Shift</strong> + <strong>B</strong>.</p>
<blockquote>
<p><strong>Note:</strong> NuGet is a Visual Studio extension that makes it easy to add, remove, and update libraries and tools in Visual Studio projects that use the .NET Framework.</p>

<p>When you install the package, NuGet copies files to your solution and automatically makes whatever changes are needed, such as adding references and changing your <em>App.config</em> or <em>Web.config</em> files. If you decide to remove the library, NuGet removes files and reverses whatever changes it made in your project so that no clutter is left.</p>

<p>For more information about NuGet, visit <a href="http://nuget.org/"><a href="http://nuget.org/">http://nuget.org/</a></a>.</p>
</blockquote></li>
<li><p>Ensure that the <strong>System.Web.Mvc</strong> assembly is included in the service package that you deploy to Windows Azure.  To do this, expand the <strong>References</strong> node in <strong>Solution Explorer</strong> for the <strong>MyTodo.WebUx</strong> project, right-click the <strong>System.Web.Mvc</strong> assembly and select <strong>Properties</strong>.</p>

<p>To add the assembly to the service package, in the <strong>Properties</strong> window for the <strong>System.Web.Mvc</strong> assembly, if <strong>Copy Local</strong> setting is set to <em>False</em> then change it to <em>True</em>.</p>

<p><img src="./Images/including-assemblies-in-the-service-package-d.png?raw=true" alt="Including assemblies in the service package deployed to Windows Azure" title="Including assemblies in the service package deployed to Windows Azure">
</p>

<p><em>Including assemblies in the service package deployed to Windows Azure</em></p>
<blockquote>
<p><strong>Note:</strong> In general, you need to set <strong>Copy Local = True</strong> for any assembly that is not installed by default in the Windows Azure VMs to ensure that it is deployed with your application. </p>
</blockquote></li>
<li><p>Next, change the size of the virtual machine that will host the application. To do this, in <strong>Solution Explorer</strong>, expand the <strong>Roles</strong> node of the <strong>MyTodo</strong> project and then double-click the <strong>MyTodo.WebUX</strong> role to open its properties window. In the <strong>Configuration</strong> page, locate the <strong>VM</strong> Size setting under the <strong>Instances</strong> category and select the <strong>Extra small</strong> size from the drop-down list.</p>

<p><img src="Images/configuring-vm-depl-size.png?raw=true" alt="Configuring the size of the virtual machine for the deployment">
</p>

<p><em>Configuring the size of the virtual machine (VM) for the deployment</em></p>
<blockquote>
<p><strong>Note:</strong> When you create your service model, you can specify the size of the virtual machine (VM) to which to deploy instances of your role, depending on its resource requirements. The size of the VM determines the number of CPU cores, the memory capacity, the local file system size allocated to a running instance, and the network throughput.</p>
</blockquote></li>
<li><p>To configure the storage account, open the <strong>ServiceConfiguration.Cloud.cscfg</strong> file located in the <strong>MyTodo</strong> project. Replace the placeholder labeled [YOUR_ACCOUNT_NAME] with the <strong>Storage Account Name</strong> that you chose when you configured the storage account in Task 1.</p></li>
<li><p>Next, replace the placeholder labeled [YOUR_ACCOUNT_KEY] with the <strong>Primary Access Key</strong> value that you recorded earlier, when you created the storage account in Task 1.</p>

<p><img src="Images/configuring-storage-account-connection.png?raw=true" alt="Configuring the storage account connection string">
</p>

<p><em>Configuring the storage account connection string</em></p></li>
<li><p>Now, set the version of the Windows Azure Guest Operating System that should run your service on the virtual machine. To do this, edit the <strong>osVersion</strong> attribute from the <strong>ServiceConfiguration</strong> root element and set its value to <em>WA-GUEST-OS-3.10_201312-01</em>, as shown in the figure below.</p>
<blockquote>
<p><strong>Note:</strong> The value used for <strong>osVersion</strong> here is to illustrate that you can select which release of the guest OS runs your application.</p>
</blockquote>
<p><img src="Images/configuring-guestos.png?raw=true" alt="Configuring the version of the guest operating system that runs the application in the VM">
</p>

<p><em>Configuring the version of the guest operating system that runs the application in the VM</em></p>
<blockquote>
<p><strong>Note:</strong> Windows Azure runs a guest operating system into which your service application will be deployed. This guest operating system is regularly updated. While rare, there is some chance that updated guest operating system versions may introduce breaking changes in your application. By setting the <strong>osVersion</strong> attribute, you ensure that your application runs in a version of the Windows Azure guest operating system that is compatible with the version of the Windows Azure SDK with which you developed it. You may then take the time to test each new <strong>osVersion</strong> prior to running it in your production deployment.</p>

<p>To configure the operating system version, you need to edit the service definition file directly because the current release of the Windows Azure Tools for Microsoft Visual Studio does not support setting this attribute through its user interface. </p>

<p>Windows Azure offers an auto-upgrade feature, that automatically upgrades your service to use the latest OS version whenever it becomes available, thus ensuring that your service runs in an environment with the latest security fixes. This is the default mode if you omit an <strong>osVersion</strong> when you deploy your service. To change an existing service to auto-upgrade mode, set the <strong>osVersion</strong> attribute to the value &quot;*&quot;.</p>

<p>For information on available versions of the Windows Azure guest operating system, see <a href="http://msdn.microsoft.com/en-us/library/ee924680.aspx">Windows Azure Guest OS Versions and SDK Compatibility Matrix</a>.</p>
</blockquote></li>
<li><p>Press <strong>CTRL + S</strong> to save the changes.</p></li>
<li><p>Configure the connection string of the SQL Database to store the application data. To do this, open the <strong>Web.config</strong> file located in the <strong>MyTodo.WebUx</strong> project. Replace the placeholder labeled [YOUR_DATABASE_SERVER] with the <strong>SQL Database server</strong> information that you recorded earlier, when you configured the SQL database in Task 1.</p></li>
<li><p>Next, configure the placeholders labeled [YOUR_DATABASE_NAME], [YOUR_USER_NAME] and [YOUR_USER_PASSWORD] with the <strong>database name</strong>, the <strong>login name</strong> and the <strong>login password</strong> that you entered when you configured the SQL database in Task 1.</p>

<p><img src="Images/configuring-the-database-connection-string.png?raw=true" alt="Configuring the database connection string">
</p>

<p><em>Configuring the database connection string</em></p></li>
<li><p>Press <strong>CTRL + S</strong> to save the changes.</p></li>
<li><p>To create a service package, right-click the cloud service project and select <strong>Package</strong>. </p></li>
<li><p>In the <strong>Package Windows Azure Application</strong> dialog box, ensure that <strong>Service configuration</strong> value is set to <em>Cloud</em>. Then click <strong>Package</strong> and wait until Visual Studio creates it. Once the package is ready, a window showing the folder that contains the generated files should open. Do not close this window, you will use the package later in this task.</p>

<p><img src="Images/creating-a-service-package.png?raw=true" alt="Creating a service package in Visual Studio">
</p>

<p><em>Creating a service package in Visual Studio</em></p></li>
<li><p>At the portal, locate the Cloud Service you previously created and click its name in order to go to the <strong>Quick Start</strong> page.</p></li>
<li><p>Click on the <strong>Dasbboard</strong> tab to navigate to the dashboard view.</p></li>
<li><p>Make sure <strong>Staging</strong> tab is selected and click <strong>Upload a new staging deployment</strong>.</p>

<p><img src="Images/uploading-the-application-to-windows-azure.png?raw=true" alt="Uploading the application to Windows Azure">
</p>

<p><em>Uploading the Application to Windows Azure</em></p>
<blockquote>
<p><strong>Note:</strong> A Cloud Service is a service that runs your code in the Windows Azure environment. It has two separate deployment slots: staging and production. The staging deployment slot allows you to test your service in the Windows Azure environment before you deploy it to production.</p>
</blockquote></li>
<li><p>In the <strong>Upload a package</strong> dialog box, enter a label to identify the deployment at the <strong>Deployment Name</strong>; for example, use <em>MyTodo-v1</em>.</p>
<blockquote>
<p><strong>Note:</strong> The management portal displays the label in its user interface for staging and production, which allows you to identify the version currently deployed in each environment.</p>
</blockquote></li>
<li><p>Under <strong>Package</strong> click <strong>From Local</strong> button, navigate to the folder where Visual Studio generated the package in the prior steps and then select <strong>MyTodo.cspkg</strong> file.</p>
<blockquote>
<p><strong>Note:</strong> The <em>.cspkg</em> file is an archive file that contains the binaries and files required to run a service.</p>
</blockquote></li>
<li><p>Now, under <strong>Configuration</strong> click <strong>From Local</strong> button and select <strong>ServiceConfiguration.Cloud.cscfg</strong> file within the same folder.</p>
<blockquote>
<p><strong>Note:</strong> The <em>.cscfg</em> file contains configuration settings for the application, including the instance count and configuration for the web role, and the storage account settings that you modified previously.</p>
</blockquote></li>
<li><p>Finally, check <strong>Deploy even if one or more roles contain a single instance</strong>. Then click the <strong>Tick</strong> button to start the deployment.</p>

<p><img src="Images/configuring-service-package-deployment.png?raw=true" alt="Configuring the service package deployment">
</p>

<p><em>Configuring the service package deployment</em></p></li>
<li><p>Notice that the package begins to upload and that the portal shows the status of the deployment to indicate its progress.</p>

<p><img src="./Images/uploading-a-service-package-to-the-windows-az.png?raw=true" alt="Uploading a service package to the Windows Azure Management Portal">
</p>

<p><em>Uploading a service package to the Windows Azure Management Portal</em></p></li>
<li><p>Wait until the deployment process finishes, which may take several minutes. At this point, you have already uploaded the package and you can view the deployment status on the dashboard. When the deployment reaches its <strong>Running</strong> state, the portal assigns a <strong>DNS name</strong> to the deployment that includes a unique identifier. Shortly, you will access this URL to test the application and determine whether it operates correctly in the Windows Azure environment, but first you need to configure it.</p>
<blockquote>
<p><strong>Note:</strong> During deployment, Windows Azure analyzes the configuration file and copies the service to the correct number of machines, and starts all the instances. Load balancers, network devices and monitoring are also configured during this time.</p>
</blockquote>
<p><img src="Images/package-successfully-uploaded.png?raw=true" alt="Application being deployed">
</p>

<p><em>Application being deployed</em></p></li>
</ol>

<p><a name="Ex1Task3" /></p>

<h4>Task 3 – Configuring the Application to Increase Number of Instances</h4>

<p>Before you can test the deployed application, you need to configure it. In this task, you change the service configuration already deployed to manually increase the number of instances.</p>

<ol>
<li><p>In the <strong>Windows Azure Management Portal</strong>, go to the <strong>Cloud Services</strong> page and click your <strong>MyTodo</strong> service name to open the service <strong>Quick Start</strong> page.</p>

<p><img src="./Images/configuring-app-settings.png?raw=true" alt="Configuring application settings" title="Configuring application settings">
</p>

<p><em>Configuring application settings</em></p></li>
<li><p>Click <strong>Scale</strong> in order to increase the number of roles your application has.</p></li>
<li><p>Make sure that the <strong>Scale by Metric</strong> option of the <strong>MyTodo.WebUx</strong> role is set to <strong>None</strong>.</p>
<blockquote>
<p><strong>Note:</strong> You can also configure your cloud service to automatically increase or decrease the number of role instances based on the <strong>average CPU usage</strong> of each instance, or the <strong>number of queue messages</strong> each instance should support. For more details, see <a href="http://www.windowsazure.com/en-us/documentation/articles/cloud-services-how-to-scale#autoscale">Automatically scale an application running Web Roles, Worker Roles, or Virtual Machines</a>.</p>

<p>Additionally, you can schedule automatic scaling of your application by configuring schedules for different times. For more details, see <a href="http://www.windowsazure.com/en-us/documentation/articles/cloud-services-how-to-scale#schedule">Schedule the scaling of your application</a>.</p>
</blockquote>
<p><img src="Images/scale-by-metric-option-disabled.png?raw=true" alt="Scale by Metric option disabled">
</p>

<p><em>Scale by Metric option disabled</em></p></li>
<li><p>In the <strong>Scale</strong> page, make sure <strong>Staging</strong> tab is selected and update the number of roles to <em>2</em>.</p>

<p><img src="Images/scaling-cloud-service.png?raw=true" alt="Scaling cloud service">
</p>

<p><em>Scaling Cloud Service</em></p>
<blockquote>
<p><strong>Note:</strong> The initial number or roles is determined by the <strong>ServiceConfiguration.cscfg</strong> file that you uploaded earlier, when you deployed the package in Task 2.</p>

<p><strong>Note:</strong> The <strong>Instances</strong> setting controls the number of roles that Windows Azure starts and is used to scale the service. For a token-based subscription —currently only available in countries that are not provisioned for billing— this number is limited to a maximum of two instances. However, in the commercial offering, you can change it to any number that you are willing to pay for.</p>
</blockquote></li>
<li><p>Click <strong>Save</strong> to update the configuration and wait for the <strong>Cloud Service</strong> to apply the new settings.</p>

<p><img src="./Images/updating-number-role-instances.png?raw=true" alt="Updating the number of role instances" title="Updating the number of role instances">
</p>

<p><em>Updating the number of role instances</em></p>
<blockquote>
<p><strong>Note:</strong> The portal displays a &quot;Changing the scale settings...&quot; message while the settings are applied.</p>
</blockquote></li>
</ol>

<p><a name="Ex1Task4" /></p>

<h4>Task 4 – Testing the Application in the Staging Environment</h4>

<p>In this task, you run the application in the staging environment and access its Web Site URL to test that it operates correctly.</p>

<ol>
<li><p>In the <strong>Cloud Services</strong> page, go to your MyTodo service <strong>Dashboard</strong> and then click the <strong>Site URL</strong> link.</p>

<p><img src="Images/running-app-staging.png?raw=true" alt="Running the application in the staging environment">
</p>

<p><em>Running the application in the staging environment</em></p>
<blockquote>
<p><strong>Note:</strong> The address URL is shown as <em>&lt;guid&gt;.cloudapp.net</em>, where &lt;<em>guid</em>&gt; is some random identifier. This is different from the address where the application will run once it is in production. Although the application executes in a staging area that is separate from the production environment, there is no actual physical difference between staging and production – it is simply a matter of where the load balancer is connected.</p>
</blockquote></li>
<li><p>Click <strong>Register</strong> to create a local account.</p>

<p><img src="Images/application-running-staging.png?raw=true" alt="Application running in the staging environment">
</p>

<p><em>Application running in the staging environment</em></p></li>
<li><p>Complete the account details by entering a user name, email address, and password and then click <strong>Register</strong>. </p>
<blockquote>
<p><strong>Note:</strong>  Account information is stored in the SQL database created earlier. Data is not shared between to-do lists.</p>
</blockquote>
<p><img src="Images/application-new-account.png?raw=true" alt="Creating a new account">
</p>

<p><em>Creating a new account</em></p></li>
<li><p>Next, the application enumerates the lists that you have currently defined. A sample todo list is provided by default for new users.</p>

<p><img src="Images/application-ready.png?raw=true" alt="Application ready to be used">
</p>

<p><em>Application ready to be used</em></p></li>
<li><p>If you wish to explore the application, update the existing to-do list, or create a new to-do list and enter some items.</p></li>
</ol>

<p><a name="Ex1Task5" /></p>

<h4>Task 5 – Promoting the Application to Production</h4>

<p>Now that you have verified that the service is working correctly in the staging environment, you are ready to promote it to final production.  When you deploy the application to production, Windows Azure reconfigures its load balancers so that the application is available at its production URL.</p>

<ol>
<li><p>In the <strong>Cloud Services</strong> page, click your MyTodo service <strong>name</strong>. Then click in the <strong>Dashboard</strong> tab and select <strong>Staging</strong>. Finally, click <strong>Swap</strong> button from the bottom menu.</p>

<p><img src="Images/promoting-app-prod.png?raw=true" alt="Promoting the application to the production slot">
</p>

<p><em>Promoting the application to the production slot</em></p></li>
<li><p>In the <strong>VIP Swap</strong> dialog box, click <strong>Yes</strong> to swap the deployments between staging and production.</p>

<p><img src="Images/promoting-app-deploy.png?raw=true" alt="Promoting the application to the production deployment">
</p>

<p><em>Promoting the application to the production deployment</em></p></li>
<li><p>Once the transition finishes, switch to <strong>Production</strong> tab and click the <strong>Site URL</strong> link to open the production site in a browser window and notice the URL in the address bar.</p>

<p><img src="Images/application-running-production.png?raw=true" alt="Application running in the production environment">
</p>

<p><em>Application running in the production environment</em></p>
<blockquote>
<p><strong>Note:</strong> If you visit the production site shortly after its promotion, the DNS name might not be ready. If you encounter a DNS error (404), wait a few minutes and try again. Keep in mind that Windows Azure creates DNS name entries dynamically and that the changes might take few minutes to propagate.</p>

<p><strong>Note:</strong> Even when a deployment is in a suspended state, Windows Azure still needs to allocate a virtual machine (VM) for each instance and charge you for it. Once you have completed testing the application, you need to remove the deployment from Windows Azure to avoid an unnecessary expense. To remove a running deployment, go to your cloud service <strong>Dashboard</strong> page, select the deployment slot where the service is currently hosted, staging or production, and then click <strong>Stop</strong> on the bottom menu. Once the service has stopped, click <strong>Delete</strong> to remove it.</p>
</blockquote></li>
</ol>

<p><a name="Exercise2" /></p>

<h3>Exercise 2: Using PowerShell to manage Windows Azure Applications</h3>

<p>Typically, during its lifetime, an application undergoes changes that require it to be re-deployed. In the previous exercise, you saw how to use the Windows Azure Management Portal to deploy applications. As an alternative, the Service Management API provides programmatic access to much of the functionality available through the Management Portal. Using the Service Management API, you can manage your storage accounts, SQL databases and cloud services, your service deployments, and your affinity groups.</p>

<p>The Windows Azure Service Management PowerShell Cmdlets wrap the Windows Azure Service Management API. These cmdlets make it simple to automate the deployment, upgrade, and scaling of your Windows Azure application. By pipelining commands, you compose complex scripts that use the output of one command as the input to another.</p>

<p>In this exercise, you will learn how to deploy and upgrade a Windows Azure application using the Azure Services Management Cmdlets. </p>

<p><a name="Ex2Task1" /></p>

<h4>Task 1 - Downloading and Importing a Publish-settings File</h4>

<p>In this task, you will log on to the Windows Azure Portal and download the publish-settings file. This file contains the secure credentials and additional information about your Windows Azure Subscription to use in your development environment. Then, you will import this file using the Windows Azure Cmdlets in order to install the certificate and obtain the account information.</p>

<ol>
<li><p>Run <strong>Windows Azure PowerShell</strong> as Administrator.</p></li>
<li><p>Change the PowerShell execution policy to <strong>RemoteSigned</strong>. When asked to confirm press <strong>Y</strong> and then <strong>Enter</strong>.</p>

<!-- mark:1 -->

<pre><code class="PowerShell">Set-ExecutionPolicy RemoteSigned
</code></pre>
<blockquote>
<p><strong>Note:</strong> The Set-ExecutionPolicy cmdlet enables you to determine which Windows PowerShell scripts (if any) will be allowed to run on your computer. Windows PowerShell has four different execution policies:</p>

<ul>
<li><em>Restricted</em> - No scripts can be run. Windows PowerShell can be used only in interactive mode.</li>
<li><em>AllSigned</em> - Only scripts signed by a trusted publisher can be run.</li>
<li><em>RemoteSigned</em> - Downloaded scripts must be signed by a trusted publisher before they can be run.</li>
<li><em>Unrestricted</em> - No restrictions; all Windows PowerShell scripts can be run.</li>
</ul>

<p>For more information about Execution Policies refer to this TechNet article: <a href="http://technet.microsoft.com/en-us/library/ee176961.aspx">http://technet.microsoft.com/en-us/library/ee176961.aspx</a></p>
</blockquote></li>
<li><p>Execute the following command to download the subscription information. This command will open a web page on the Windows Azure Management Portal.</p>

<pre><code class="PowerShell">Get-AzurePublishSettingsFile
</code></pre></li>
<li><p>Sign in using the Microsoft Account associated with your Windows Azure account.</p></li>
<li><p><strong>Save</strong> the Publish Settings file to your local machine.</p>

<p><img src="Images/downloading-publish-settings-file.png?raw=true" alt="Downloading publish-settings file" title="Downloading publish-settings file">
</p>

<p><em>Downloading Publish Settings file</em></p></li>
<li><p>The following script imports your publish-settings file and persists this information for later use. You will use these values during the lab to manage your Windows Azure Subscription. Replace the placeholder with your publish-setting file’s path and execute the script.</p>

<!-- mark:1 -->

<pre><code class="PowerShell">Import-AzurePublishSettingsFile '[YOUR-PUBLISH-SETTINGS-PATH]'
</code></pre></li>
<li><p>Execute the following commands to determine your subscription and storage account name.</p>

<!-- mark:1-2 -->

<pre><code class="PowerShell">Get-AzureSubscription | select SubscriptionName
Get-AzureStorageAccount | select StorageAccountName 
</code></pre></li>
<li><p>Execute the following commands to set your current storage account for your subscription.</p>

<!-- mark:1 -->

<pre><code class="PowerShell">Set-AzureSubscription -SubscriptionName '[YOUR-SUBSCRIPTION-NAME]' -CurrentStorageAccount '[YOUR-STORAGE-ACCOUNT]' 
</code></pre></li>
</ol>

<p><a name="Ex2Task2" /></p>

<h4>Task 2 – Configuring the Application</h4>

<p>In this task, you will configure the application using your SQL database and storage account information and generate a package to publish it using Windows Azure PowerShell CmdLets.</p>

<ol>
<li><p>If it is not already open, launch <strong>Microsoft Visual Studio Express 2013 for Web</strong> (or greater) as Administrator.</p></li>
<li><p>In the <strong>File</strong> menu, choose <strong>Open Project</strong> and browse to <strong>Ex2-DeployingWithPowerShell\Begin</strong> in the <strong>Source</strong> folder of the lab. Select <strong>MyTodo.sln</strong> and click Open.</p>
<blockquote>
<p><strong>Note:</strong> Alternatively, you may continue with the solution that you completed during Exercise 1. You can dismiss this task if you selected to continue with the solution from Exercise 1.</p>
</blockquote></li>
<li><p>Configure the storage account connection strings. To do this, expand the <strong>Roles</strong> node in the <strong>MyTodo</strong> project and double-click the <strong>MyTodo.WebUX</strong> role. In the role properties window, select the <strong>Settings</strong> tab and select <em>Cloud</em> from the <strong>Service Configuration</strong> drop-down list. Then select the <em>Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString</em> setting, ensure that the <strong>Type</strong> is set to <em>Connection String</em>, and then click the button labeled with an ellipsis.</p>

<p><img src="Images/defining-connection-settings.png?raw=true" alt="Defining storage account connection settings">
</p>

<p><em>Defining storage account connection settings</em></p></li>
<li><p>In the <strong>Create Storage Connection String</strong> dialog box, select the <strong>Manually entered credentials</strong> option. Enter your storage <strong>Account Name</strong> and storage <strong>Account Key</strong> and click <strong>OK</strong>.</p>

<p><img src="./Images/defining-connection-settings-2.png?raw=true" alt="Configuring the storage account name and account key" title="Configuring the storage account name and account key">
</p>

<p><em>Configuring the storage account name and account key</em></p>
<blockquote>
<p><strong>Note:</strong> This information is available in the <strong>Dashboard</strong> section of your storage account in the Windows Azure Management Portal. You used the same settings in Exercise 1, when you deployed and configured the application. </p>
</blockquote></li>
<li><p>Press <strong>CTRL + S</strong> to save your changes. </p></li>
<li><p>Next, open the <strong>Web.config</strong> file located in the <strong>MyTodo.WebUx</strong> project. Replace the placeholders with the <strong>SQL Database server</strong>, <strong>database name</strong>, <strong>login name</strong> and <strong>login password</strong> of your SQL database.</p>

<p><img src="Images/configuring-the-database-connection-string.png?raw=true" alt="Configuring the database connection string">
</p>

<p><em>Configuring the database connection string</em></p></li>
<li><p>Press <strong>CTRL + S</strong> to save the changes.</p></li>
<li><p>To create a service package, right-click the cloud service project and select <strong>Package</strong>. In the <strong>Package Windows Azure Application</strong> dialog, ensure that <strong>Service configuration</strong> value is set to <em>Cloud</em>. Click <strong>Package</strong> and then wait until Visual Studio creates it. Once the package is ready, Visual Studio opens a window showing the folder that contains the generated files.</p></li>
</ol>

<p><a name="Ex2Task3" /></p>

<h4>Task 3 – Uploading a Service Package Using Windows PowerShell</h4>

<p>In the previous exercise, you uploaded the service package for the myTODO application using the Windows Azure Management Portal. In this task, you deploy the package using the Windows Azure Service Management PowerShell cmdlets instead. </p>

<ol>
<li><p>If not already open, open a <strong>Windows Azure PowerShell</strong> command prompt as Administrator.</p></li>
<li><p>Change the current directory to the location where you generated the service package for the myTODO application in the previous task. For your facility you might want to copy the packages into a shorter URL path (e.g. <em>C:\HOL</em>).</p></li>
<li><p>Next, enter the command shown below. Use the following command line arguments ensuring that you replace the parameter placeholders with the settings that apply to your service account.</p>

<!-- mark:1-5 -->

<pre><code class="PowerShell">$serviceName = '[YOUR-SERVICE-NAME-LOWER-CASE]'
$packageLocation = '[PACKAGE-LOCATION]'
$configurationLocation = '[CONFIGURATION-LOCATION]'
$deploymentLabel = 'MyTodo-v2'
New-AzureDeployment -ServiceName $serviceName -Package $packageLocation -Configuration $configurationLocation -Slot 'Staging' -Label $deploymentLabel -DoNotStart
</code></pre>

<table><thead>
<tr>
<td></td>
<td></td>
</tr>
</thead><tbody>
<tr>
<td>[YOUR-SERVICE-NAME-LOWER-CASE]</td>
<td>The service name chosen when configuring the cloud service URL in Exercise 1, not its Service Label.</td>
</tr>
<tr>
<td>[PACKAGE-LOCATION]</td>
<td>A path to a local file or the URL of the blob in your Storage Account that contains the service package.</td>
</tr>
<tr>
<td>[CONFIGURATION-LOCATION]</td>
<td>A path to a local file or the public URL of the blob that contains the service configuration file.</td>
</tr>
<tr>
<td>[YOUR-DEPLOYMENT-LABEL]</td>
<td>The deployment label.</td>
</tr>
</tbody></table><blockquote>
<p><strong>Note:</strong> The command shown above uses the <strong>New-AzureDeployment</strong> cmdlet to upload a service package and create a new deployment in the staging environment. It assigns a &quot;MyTodo-v2&quot; label to identify this deployment.</p>
</blockquote></li>
<li><p>Press <strong>ENTER</strong> to execute the command and wait until the <strong>New-AzureDeployment</strong> command finishes.</p>

<p><img src="./Images/command-line-deploying-powershell.png?raw=true" alt="Deploying a new service package to Windows Azure using PowerShell" title="Deploying a new service package to Windows Azure using PowerShell">
</p>

<p><em>Deploying a new service package to Windows Azure using PowerShell</em></p></li>
<li><p>In the Windows Azure Management Portal, open the Cloud Service's <strong>Dashboard</strong> page and notice how the deployment for the staging environment shows its status with the message &quot;<strong>Updating deployment...</strong>&quot; in the UI. It may take a few seconds for the service status to refresh. Wait for the deployment operation to complete and display the status as <strong>Stopped</strong>.</p>

<p><img src="./Images/deployment-stopped.png?raw=true" alt="Deployment Stopped" title="Deployment Stopped">
</p>

<p><em>Deployment Stopped</em></p>
<blockquote>
<p><strong>Note:</strong> Normally, you will not use the management portal to view the status and determine the outcome of your deployment operations. Here, it is shown to highlight the fact that you can use the management API to execute the same operations that are available in the management portal. In the next task, you will see how to use a cmdlet to wait for the operation to complete and retrieve its status.</p>
</blockquote></li>
<li><p>Keep Microsoft Visual Studio and the PowerShell console open. You will need them for the next task.</p></li>
</ol>

<p><a name="Ex2Task4" /></p>

<h4>Task 4 – Upgrading a Deployment Using Windows PowerShell</h4>

<p>In this task, you use the Windows Azure PowerShell cmdlets to upgrade an existing deployment. First, you will change the original solution by making minor changes to its source code to produce an updated version of the application. Next, you will build the application and create a new service package that contains the updated binaries. Finally, you will re-deploy the package to Windows Azure using the management cmdlets. </p>

<ol>
<li><p>Go back to Microsoft Visual Studio. </p></li>
<li><p>Open the layout view of the application for editing. To do this, in <strong>Solution Explorer</strong>, double-click <strong>Index.cshtml</strong> in the <strong>Views\Home</strong> folder of the <strong>MyTodo.WebUx</strong> project.</p></li>
<li><p>Insert a new caption in the footer area of the page. Go to the bottom of the layout view and update the copyright notice with the text &quot;(<em>Deployed with the PowerShell CmdLets</em>)&quot; as shown below.</p>

<!-- mark:4 -->

<pre><code class="HTML">...
&lt;hr /&gt;
&lt;footer&gt;
    &lt;p&gt;&amp;copy; @DateTime.Now.Year - myTODO (Deployed with the PowerShell CmdLets)&lt;/p&gt;
&lt;/footer&gt;
...
</code></pre></li>
<li><p>Generate a new service package. To do this, in <strong>Solution Explorer</strong>, right-click the cloud service project and select <strong>Package</strong>. In the <strong>Package Windows Azure Application</strong> dialog, ensure that <strong>Service configuration</strong> value is set to <em>Cloud</em>. Click <strong>Package</strong> and then wait until Visual Studio creates it. Once the package is ready, Visual Studio opens a window showing the folder that contains the generated files. </p></li>
<li><p>Switch to the PowerShell console and enter the command shown below, specifying the settings that apply to your service account where indicated by the placeholder parameters. Do <strong>not</strong> execute the command yet.</p>

<!-- mark:1-4 -->

<pre><code class="PowerShell">$packageLocation = '[PACKAGE-LOCATION]'
$configurationLocation = '[CONFIGURATION-LOCATION]'
$deploymentLabel = 'MyTodo-v21'
Get-AzureService -ServiceName $serviceName | Get-AzureDeployment -Slot staging | Set-AzureDeployment -Package $packageLocation -Configuration $configurationLocation -Upgrade -Label $deploymentLabel
</code></pre>
<blockquote>
<p><strong>Note:</strong> The command line shown above concatenates a sequence of cmdlets. First, it obtains a reference to the cloud service using <strong>Get-AzureService</strong>, then it uses <strong>Get-AzureDeployment</strong> to retrieve its <em>staging</em> environment, and finally it uploads the package using <strong>Set-AzureDeployment</strong>. This is done to illustrate how to compose a complex command using the PowerShell pipeline. In fact, in this particular case, you could instead provide all the required information to <strong>Set-AzureDeployment</strong> to achieve the same result. For example:</p>
<blockquote>
<p>Set-AzureDeployment -Upgrade -ServiceName $serviceName -Package $packageLocation -Configuration $configurationLocation -Slot 'Staging' -Label $deploymentLabel </p>
</blockquote></blockquote></li>
<li><p>Press <strong>ENTER</strong> to execute the command. Wait until the deployment process finishes, which may take several minutes. When the operation ends, it displays a message with the outcome of the operation; if the deployment completes without errors, you will see the &quot;Succeeded&quot; message.</p>

<p><img src="./Images/command-line-powershell-status.png?raw=true" alt="PowerShell console showing the status of the package deployment operation" title="PowerShell console showing the status of the package deployment operation">
</p>

<p><em>PowerShell console showing the status of the package deployment operation</em></p>
<blockquote>
<p><strong>Note:</strong> Deploying a package using the steps described above does not change its state. If the service is not running prior to deployment, it will remain in that state. To start the service, you need to update its deployment status using the <strong>Set-AzureDeployment</strong> cmdlet.</p>
</blockquote></li>
<li><p>To change the status of the service to a running state, in the <strong>PowerShell</strong> console, enter the following command.</p>

<!-- mark:1 -->

<pre><code class="PowerShell">Set-AzureDeployment -Status -ServiceName $serviceName -NewStatus 'Running' -Slot 'Staging'
</code></pre></li>
<li><p>Finally, swap the deployments in the staging and production environments. To do this, in the <strong>PowerShell</strong> console, use the <strong>Get-Deployment</strong> and <strong>Move-Deployment</strong> cmdlets, as shown below.</p>

<!-- mark:1 -->

<pre><code class="PowerShell">Get-AzureService -ServiceName $serviceName | Get-AzureDeployment -Slot staging | Move-AzureDeployment
</code></pre></li>
</ol>

<p><a name="Ex2Task5" /></p>

<h4>Task 5 - Verification</h4>

<p>Now that you have deployed your updated solution to Window Azure, you are ready to test it. You will launch the application to determine if the deployment succeeded and ensure that the service is working correctly and is available at its production URL. </p>

<ol>
<li><p>In your Cloud Service <strong>Dashboard</strong> page within the management portal, click the <strong>Web Site URL</strong> link to open the production site in a browser window. Notice the footer of the page. It should reflect the updated text that you entered in the last task.</p>

<p><img src="Images/new-deployment.png?raw=true" alt="New deployment showing the updated footer text">
</p>

<p><em>New deployment showing the updated footer text</em></p>
<blockquote>
<p><strong>Note:</strong> If you visit the production site shortly after its promotion, the DNS name might not be ready. If you encounter a DNS error (404), wait a few minutes and try again. Keep in mind that Windows Azure creates DNS name entries dynamically and that the changes might take few minutes to propagate.</p>
</blockquote></li>
</ol>

<p><a name="Exercise3" /></p>

<h3>Exercise 3: Using Visual Studio to Publish Applications</h3>

<p>Previously, you learnt how to deploy applications to Windows Azure using the Management Portal and a set of PowerShell cmdlets. If you are a developer, you may find it more convenient during your development cycle to deploy your applications directly from Visual Studio. </p>

<p>The first time you publish a service to Windows Azure using Visual Studio, you need to create the necessary credentials to access your account. For doing this, you will use the PublishSettings file you downloaded in the previous exercise. </p>

<p>Once you set up your account information in Visual Studio, you can publish your current solution in the background with only a few mouse clicks.</p>

<p>In this exercise, you will set up the credentials to authenticate with the Windows Azure Management Service and then publish the myTODO application from Visual Studio.</p>

<p><a name="Ex3Task1" /></p>

<h4>Task 1 – Preparing the Solution for Publish</h4>

<p>When you publish your service using Visual Studio, the Windows Azure Tools upload the service package and then automatically start it. You will not have a chance to update the configuration settings before the service starts. Therefore, you must configure all the necessary settings before you publish the service.</p>

<p>In this task, you will update the storage connection strings to point to your SQL database and your storage account.</p>

<ol>
<li><p>If it is not already open, launch <strong>Microsoft Visual Studio Express 2013 for Web</strong> (or greater) as Administrator.</p></li>
<li><p>In the <strong>File</strong> menu, choose <strong>Open Project</strong> and browse to <strong>Ex3-DeployingWithVisualStudio\Begin</strong> in the <strong>Source</strong> folder of the lab. Select <strong>MyTodo.sln</strong> and click Open.</p>
<blockquote>
<p><strong>Note:</strong> This is the same solution deployed earlier except for a legend in its footer area to indicate that it was deployed using <strong>Visual Studio</strong>.</p>
</blockquote></li>
<li><p>In <strong>Solution Explorer</strong>, expand the <strong>Roles</strong> node in the <strong>MyTodo</strong> project, double-click the <strong>MyTodo.WebUx</strong> role to open its properties window, and then switch to the <strong>Settings</strong> tab.</p></li>
<li><p>Configure the storage account connection strings. To do this, expand the <strong>Roles</strong> node in the <strong>MyTodo</strong> project and double-click the <strong>MyTodo.WebUX</strong> role. In the role properties window, select the <strong>Settings</strong> tab and select <em>Cloud</em> from the <strong>Service Configuration</strong> drop-down list. Then select the <em>Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString</em> setting, ensure that the <strong>Type</strong> is set to <em>Connection String</em>, and then click the button labeled with an ellipsis.</p>

<p><img src="./Images/defining-connection-settings.png?raw=true" alt="Defining storage account connection settings" title="Defining storage account connection settings">
</p>

<p><em>Defining storage account connection settings</em></p></li>
<li><p>In the <strong>Create Storage Account Connection String</strong> dialog box, select the <strong>Manually entered credentials</strong> option. Complete your storage <strong>Account Name</strong> and storage <strong>Account Key</strong> and click <strong>OK</strong>.</p>

<p><img src="./Images/defining-connection-settings-2.png?raw=true" alt="Configuring the storage account name and account key" title="Configuring the storage account name and account key">
</p>

<p><em>Configuring the storage account name and account key</em></p>
<blockquote>
<p><strong>Note:</strong> This information is available in the <strong>Dashboard</strong> section of your storage account in the Windows Azure Management Portal. You used the same settings in Exercise 1, when you deployed and configured the application. </p>
</blockquote></li>
<li><p>Press <strong>CTRL + S</strong> to save your changes. </p></li>
<li><p>Next, open the <strong>Web.config</strong> file located in the <strong>MyTodo.WebUx</strong> project. Replace the placeholders with the <strong>SQL Database server</strong>, <strong>database name</strong>, <strong>login name</strong> and <strong>login password</strong> of your SQL database.</p>

<p><img src="Images/configuring-the-database-connection-string.png?raw=true" alt="Configuring the database connection string">
</p>

<p><em>Configuring the database connection string</em></p></li>
<li><p>Press <strong>CTRL + S</strong> to save the changes.</p></li>
</ol>

<p><a name="Ex3Task2" /></p>

<h4>Task 2 – Publishing a Service with the Windows Azure Tools</h4>

<p>In this task, you will configure a set of credentials that provide access to your Windows Azure account. Visual Studio saves this information and allows you to reuse the credentials whenever you need to publish a service, without requiring you to enter your credentials again.</p>

<p>Then, you will use these credentials to publish the myTODO application directly from Visual Studio.</p>

<ol>
<li><p>In <strong>Solution Explorer</strong>, right-click the <strong>MyTodo</strong> cloud project and select <strong>Publish</strong>.</p></li>
<li><p>In the <strong>Publish Windows Azure Application</strong> dialog box, click the subscription drop-down list and select <strong>Manage...</strong>.</p>

<p><img src="Images/manage-subscriptions.png?raw=true" alt="Manage subscriptions">
</p>

<p><em>Manage subscriptions</em></p></li>
<li><p>In the <strong>Manage Windows Azure Subscriptions</strong> dialog box, select the <strong>Certificates</strong> tab and click <strong>Import...</strong>.</p>

<p><img src="Images/import-subscription.png?raw=true" alt="Import Subscription">
</p>

<p><em>Import Subscription</em></p></li>
<li><p>In the <strong>Import Windows Azure Subscriptions</strong> dialog box, click <strong>Browse...</strong>, locate the publish-settings file you downloaded in the previous exercise, select it and click <strong>Open</strong>. Then click <strong>Import</strong>.</p>
<blockquote>
<p><strong>Note:</strong> It is recommended that you delete the publish-settings file after you import those settings. Because the management certificate includes security credentials, it should not be accessed by unauthorized users. If you need information about your subscriptions, you can get it from the Windows Azure Management Portal or the Microsoft Online Services Customer Portal.</p>
</blockquote>
<p><img src="Images/import-subscription-2.png?raw=true" alt="Select and import subscription file">
</p>

<p><em>Select and import subscription file</em></p></li>
<li><p>Click <strong>Close</strong>. Back in the <strong>Publish Windows Azure Application</strong> dialog box, select the subscription created from the publish-settings file and click <strong>Next</strong>.</p>

<p><img src="Images/waz-sign-in.png?raw=true" alt="Signing in">
</p>

<p><em>Signing in</em></p></li>
<li><p>In the <strong>Common Settings</strong> tab, notice that the dialog populates the drop-down list labeled <strong>Cloud Service</strong> with the information for all the services configured in your Windows Azure account. Select the cloud service in this list where you wish to deploy the application.</p></li>
<li><p>Make sure the <strong>Environment</strong> is set to <em>Production</em> and the <strong>Build Configuration</strong> to <em>Release</em>. Also, set the <strong>Service Configuration</strong> to <em>Cloud</em>.</p>

<p><img src="Images/deployment-common-settings.png?raw=true" alt="Deployment Common Settings">
</p>

<p><em>Deployment Common Settings</em></p></li>
<li><p>Click the <strong>Advanced Settings</strong> tab. Update the <strong>Deployment Label</strong> to <em>MyTodo</em> and select the check box labeled <strong>Append date and time</strong> to identify the deployment in the Developer Portal UI.</p></li>
<li><p>Like with the cloud services, the drop-down list labeled <strong>Storage account</strong> is populated with all the storage services that you have configured in your Windows Azure account. To publish a service, Visual Studio first uploads the service package to storage in Windows Azure, and then publish the service from there. Select the storage service that you wish to use for this purpose and click <strong>Next</strong>.</p>

<p><img src="Images/deployment-advanced-settings.png?raw=true" alt="Deployment Advanced Settings">
e)</p>

<p><em>Deployment Advanced Settings</em></p>
<blockquote>
<p><strong>Note:</strong> The <strong>Enable Remote Debugger for all roles</strong> option allows you to attach the Visual Studio debugger to a running cloud service in Windows Azure. The remote debugging feature is available in Visual Studio Professional edition (or greater).</p>

<p>The Ultimate edition of Visual Studio provides an option to enable <strong>IntelliTrace</strong>. With IntelliTrace, you can capture detailed trace logs of your running service in the cloud that you can download to your desktop to perform historical debugging. This can be invaluable when troubleshooting issues that occur during role start up.</p>
</blockquote></li>
<li><p>Review the Summary information. If everything is OK, click <strong>Publish</strong> to start the deployment process.</p>

<p><img src="Images/start-deployment.png?raw=true" alt="Starting Deployment">
</p>

<p><em>Starting Deployment</em></p>
<blockquote>
<p><strong>Note:</strong> At the top of the dialog box, you will find a Target Profile drop down list. Once you configured your deployment settings, you can save them as a new profile and use it later without having to complete all the fields again.</p>
</blockquote></li>
<li><p>If the slot that you chose is already occupied by a previous deployment, Visual Studio warns you and asks for confirmation before it replaces it. Click <strong>Replace</strong> if you are certain that the current deployment is no longer needed and can be overwritten. Otherwise, click <strong>Cancel</strong> and repeat the operation choosing a different deployment slot.</p>

<p><img src="./Images/overwrite-existing-deployment.png?raw=true" alt="Overwriting an existing deployment">
</p>

<p><em>Overwriting an existing deployment</em></p></li>
<li><p>After you start a deployment, you can examine the Windows Azure activity log window to determine the status of the operation. If this window is not visible, in the <strong>View</strong> menu, point to <strong>Other Windows</strong>, and then select <strong>Windows Azure Activity Log</strong>.</p></li>
<li><p>By default, the log shows a descriptive message and a progress bar to indicate the status of the deployment operation. </p>

<p><img src="Images/waz-activity-summary.png?raw=true" alt="Viewing summary information in the Windows Azure activity log">
</p>

<p><em>Viewing summary information in the Windows Azure activity log</em></p></li>
<li><p>To view detailed information about the deployment operation in progress, click the arrow on the left side of the activity log entry.
Notice that the additional information provided includes the deployment slot, <strong>Production</strong> or <strong>Staging</strong>, the <strong>Website URL</strong>, the <strong>Deployment ID</strong>, and a <strong>History</strong> log that shows state changes, including the time when each change occurred. </p>

<p><img src="Images/detailed-deployment-information.png?raw=true" alt="Viewing detailed information about a deployment operation">
</p>

<p><em>Viewing detailed information about a deployment operation</em></p></li>
<li><p>Wait for the deployment operation to complete, which may take several minutes. While this is happening, you can examine the <strong>History</strong> panel on the right side to determine the status of the deployment. For a successful deployment, it should resemble the following sequence.</p>

<p><img src="Images/deployment-operation-log.png?raw=true" alt="Deployment operation history log">
</p>

<p><em>Deployment operation history log</em></p></li>
<li><p>Once the deployment operation is complete, in the <strong>Windows Azure Activity Log</strong>, click the <strong>Website URL</strong> link for the completed operation to open the application in your browser and ensure that it is working properly. Notice the legend in the copyright at the bottom of the page indicating that this is the version that you deployed with Visual Studio.</p>

<p><img src="Images/running-deployment.png?raw=true" alt="Running the application deployed with Visual Studio">
</p>

<p><em>Running the application deployed with Visual Studio</em></p></li>
</ol>

<p><a name="Exercise4" /></p>

<h3>Exercise 4: Securing Windows Azure with SSL</h3>

<p>In this exercise, you will enable SSL to secure the myTODO application. This involves creating a self-signed certificate for server authentication and uploading it to the Windows Azure portal. With the certificate in place, you will add a new HTTPS endpoint to the service model and assign the certificate to this endpoint. You will complete the exercise by deploying the application to Windows Azure one more time and then access it using its HTTPS endpoint.</p>

<p><a name="Ex4Task1" /></p>

<h4>Task 1 – Adding an HTTPS Endpoint to the Application</h4>

<p>In this task, you will update the service model of myTODO to add an HTTPS endpoint and then you test the application in the compute emulator.</p>

<ol>
<li><p>If it is not already open, launch <strong>Microsoft Visual Studio Express 2013 for Web</strong> (or greater) as Administrator.</p></li>
<li><p>In the <strong>File</strong> menu, choose <strong>Open Project</strong> and browse to <strong>Ex4-SecuringAppWithSSL\Begin</strong> in the <strong>Source</strong> folder of the lab. Select <strong>MyTodo.sln</strong> and click Open.</p></li>
<li><p>In <strong>Solution Explorer</strong>, expand the <strong>Roles</strong> node in the <strong>MyTodo</strong> project, and then double-click the <strong>MyTodo.WebUx</strong> role to open its properties window.</p></li>
<li><p>Switch to the <strong>Endpoints</strong> tab. In the existing endpoint entry, set the <strong>Protocol</strong> field to <em>HTTPS</em>, enter the <em>443</em> value for the <strong>Public Port</strong> field and leave the <strong>Name</strong> field unchanged. Do not set the SSL certificate at this time; you will do that later in the exercise.</p>

<p><img src="Images/adding-https-endpoint.png?raw=true" alt="Adding an HTTPs endpoint to the application">
</p>

<p><em>Adding an HTTPs endpoint to the application</em></p></li>
<li><p>Now, select the HTTPS endpoint as the one to use when you launch the application in the browser when you are debugging it. To do this, right-click the <strong>MyTodo.WebUx</strong> role in the <strong>MyTodo</strong> project, point to <strong>Launch in Browser</strong>, and ensure that only <strong>HTTPS</strong> is selected.</p>

<p><img src="Images/selecting-debug-endpoint.png?raw=true" alt="Selecting the endpoint used to debug the application">
</p>

<p><em>Selecting the endpoint used to debug the application</em></p></li>
<li><p>You will now test the application locally. Press <strong>F5</strong> to build and launch the application in the compute emulator. Notice that the browser indicates that there is a problem with the certificate. Ignore the warning and click <strong>Continue to this website</strong>.</p>

<p><img src="./Images/certificate-error-computer-emulator.png?raw=true" alt="Certificate error when testing in the compute emulator" title="Certificate error when testing in the compute emulator">
</p>

<p><em>Certificate error when testing in the compute emulator</em></p>
<blockquote>
<p><strong>Note:</strong> When testing your application in the local development environment using SSL, you do not need to configure a certificate. Instead, the compute emulator handles this requirement by using its own certificate. However, the certification authority for the certificate that it uses is not trusted, hence the warning. You may safely ignore the warning while you test your application locally.</p>

<p>If you wish, you can remove the warning by installing the certificate in the <strong>Trusted Root Certification Authorities</strong> certificate store. Note, however, that this has security implications that you need to evaluate before you proceed.</p>

<p>To remove the warning, open the <strong>Microsoft Management Console</strong> by pressing Windows key and searching for <strong>MMC</strong>. Add an instance of the <strong>Certificates</strong> snap-in and configure it to manage certificates for the <strong>Computer</strong> account. Expand the <strong>Personal\Certificates</strong> store and locate a certificate issued to 127.0.0.1. To ensure that you have the right certificate, view its properties to verify that the <strong>Subject</strong> and <strong>Issuer</strong> fields identify the certificate as belonging to the compute emulator. To trust the certificate, simply drag and drop the certificate from the <strong>Personal</strong> certificate store into the <strong>Trusted Root Certification Authorities</strong> certificate store.</p>

<p><img src="./Images/computer-emulator-certificate.png?raw=true" alt="Certificate used by the compute emulator to implement SSL" title="Certificate used by the compute emulator to implement SSL">
</p>

<p><em>Certificate used by the compute emulator to implement SSL</em></p>
</blockquote></li>
<li><p>After you access the home page, notice that the address bar shows that you are now accessing the HTTPS endpoint.</p>

<p><img src="Images/accessing-endpoints.png?raw=true" alt="Accessing the HTTPS endpoint in the compute emulator">
</p>

<p><em>Accessing the HTTPS endpoint in the compute emulator</em></p></li>
<li><p>Close the browser window. You will now create a self-signed certificate and deploy the application to Windows Azure.</p></li>
<li><p>Do not close the project in Visual Studio. You will need it shortly.</p></li>
</ol>

<p><a name="Ex4Task2" /></p>

<h4>Task 2 – Creating a Self-Signed Certificate</h4>

<p>In this task, you will create a self-signed certificate that you can upload to the Windows Azure Developer Portal to configure an SSL endpoint for your application.</p>
<blockquote>
<p><strong>Note:</strong> if you are unable to use Internet Information Services (IIS) Manager in your environment, you may skip this task. Instead, you can find a self-signed certificate that you can use among the lab’s resources.</p>

<p>To install the certificate, open Windows Explorer, browse to <strong>Assets</strong> in the <strong>Source</strong> folder of the lab and then double-click the <strong>MyTodoCertificate.pfx</strong> file to install the certificate using the <strong>Certificate Import Wizard</strong>. Select <strong>Local Machine</strong> as the store location and use &quot;password1&quot; (without the quotation marks) as the password. Use default values for all other options.</p>

<p><strong>Important:</strong> You should only use this certificate to complete the steps in the exercise. Do not use the certificate in your production deployments.</p>
</blockquote>
<ol>
<li><p>Start Internet Information Services Manager. To do this, click the Windows button and type &quot;iis&quot; in the search box and then click <strong>Internet Information Services (IIS) Manager</strong> in the list of installed programs.</p>

<p><img src="Images/iis-manager-launch.png?raw=true" alt="Launching Internet Information Services (IIS) Manager">
</p>

<p><em>Launching Internet Information Services (IIS) Manager</em></p></li>
<li><p>In the <strong>Connections</strong> pane of the Internet Information Services (IIS) Manager console, select the top-level node corresponding to your computer. Next, locate the <strong>IIS</strong> category in the middle pane and double-click <strong>Server Certificates</strong>.</p>

<p><img src="./Images/iis-managing-certificates.png?raw=true" alt="Managing certificates with Internet Information Services (IIS) Manager" title="Managing certificates with Internet Information Services \(IIS\) Manager">
</p>

<p><em>Managing certificates with Internet Information Services (IIS) Manager</em></p></li>
<li><p>In the <strong>Server Certificates</strong> page, click <strong>Create Self-Signed Certificate</strong> in the <strong>Actions</strong> pane.</p>

<p><img src="./Images/iis-creating-self-signed-certificate.png?raw=true" alt="Creating a self-signed certificate in the Internet Information Services (IIS) Manager" title="Creating a self-signed certificate in the Internet Information Services \(IIS\) Manager">
</p>

<p><em>Creating a self-signed certificate in the Internet Information Services (IIS) Manager</em></p></li>
<li><p>In the <strong>Specify Friendly Name</strong> page of the <strong>Create Self-Signed Certificate</strong> wizard, enter a name to identify your certificate —this can be any name, for example, <strong>MyTodoCertificate</strong>—, and then click <strong>OK</strong>.</p>

<p><img src="./Images/iis-specifying-certificate-name.png?raw=true" alt="Specifying a name for the certificate" title="Specifying a name for the certificate">
</p>

<p><em>Specifying a name for the certificate</em></p></li>
<li><p>Now, right-click the newly created certificate and select <strong>Export</strong> to store the certificate in a file. </p>

<p><img src="./Images/iis-server-certificates.png?raw=true" alt="Server certificates page showing the new self-signed certificate" title="Server certificates page showing the new self-signed certificate">
</p>

<p><em>Server certificates page showing the new self-signed certificate</em></p></li>
<li><p>In the <strong>Export Certificate</strong> dialog box, enter the name of a file in which to store the certificate for exporting, type a password and confirm it, and then click <strong>OK</strong>. Take a note of the password. You will require it later on, when you upload the certificate to the portal.</p>

<p><img src="./Images/iis-exporting-certificate.png?raw=true" alt="Exporting the certificate to a file">
</p>

<p><em>Exporting the certificate to a file</em></p></li>
</ol>

<p><a name="Ex4Task3" /></p>

<h4>Task 3 – Adding the Certificate to the Service Model of the Application</h4>

<p>Previously, when you tested SSL access to the application in your local environment, you were able to do so without specifying a certificate by taking advantage of the certificate managed by the compute emulator. In this task, you will configure the application to use the self-signed certificate that you created in Internet Information Services (ISS) Manager.</p>

<ol>
<li><p>Switch back to Visual Studio. If you closed the project, you will need to reopen it from <strong>Ex4-SecuringAppWithSSL\Begin</strong> in the <strong>Source</strong> folder of the lab.</p></li>
<li><p>In <strong>Solution Explorer</strong>, expand the <strong>Roles</strong> node in the <strong>MyTodo</strong> project, double-click the <strong>MyTodo.WebUx</strong> role to open its properties window, and then switch to the <strong>Certificates</strong> tab.</p></li>
<li><p>In the <strong>Certificates</strong> page, click <strong>Add Certificate</strong>. Complete the <strong>Name</strong> field with a value that identifies the certificate that you are adding, for example, use <em>SSL</em>. Ensure that the <strong>Store Location</strong> is set to <em>LocalMachine</em> and the <strong>Store Name</strong> is set to <em>My</em> and then click the button labeled with an ellipsis, to the right of the <strong>Thumbprint</strong> column.</p>

<p><img src="Images/adding-certificate.png?raw=true" alt="Adding a certificate for the service">
</p>

<p><em>Adding a certificate for the service</em></p></li>
<li><p>In the <strong>Select a certificate</strong> dialog, select the self-signed certificate that you created earlier and then click <strong>OK</strong>. </p>

<p><img src="./Images/selecting-certificate.png?raw=true" alt="Choosing a certificate for the service" title="Choosing a certificate for the service">
</p>

<p><em>Choosing a certificate for the service</em></p></li>
<li><p>Notice that the dialog populates the <strong>Thumbprint</strong> column with the corresponding value from the certificate.</p>

<p><img src="Images/adding-certificate-service-model.png?raw=true" alt="Adding a certificate to the service model of the application">
</p>

<p><em>Adding a certificate to the service model of the application</em></p></li>
<li><p>Now, switch to the <strong>Endpoints</strong> tab and, in the <strong>HTTPS</strong> input endpoints section, expand the <strong>SSL certificate name</strong> drop down list and select the certificate that you added to the service in the previous step.</p>

<p><img src="Images/choosing-certificate-https-endpoint.png?raw=true" alt="Choosing a certificate to use for the HTTPS endpoint">
</p>

<p><em>Choosing a certificate to use for the HTTPS endpoint</em></p></li>
<li><p>Press <strong>CTRL+S</strong> to save the changes to the configuration.</p></li>
</ol>

<p><a name="Ex4Task4" /></p>

<h4>Task 4 – Uploading the Certificate to the Windows Azure Management Portal</h4>

<p>In this task, you will upload the self-signed certificate created previously to the Windows Azure Management Portal.</p>

<ol>
<li><p>Navigate to <a href="http://manage.windowsazure.com"><a href="http://manage.windowsazure.com">http://manage.windowsazure.com</a></a> using a Web browser and sign in using your Microsoft account.</p></li>
<li><p>In the <strong>Cloud Services</strong> page, click your cloud service's <strong>name</strong> to go to the service's <strong>Quick Start</strong> page.</p></li>
<li><p>Click <strong>Certificates</strong> and then <strong>Upload a certificate</strong>.</p>

<p><img src="Images/adding-a-new-certificate.png?raw=true" alt="Adding a new certificate">
</p>

<p><em>Adding a new Certificate</em></p></li>
<li><p>In the <strong>Upload Certificate</strong> dialog, click <strong>Browse</strong>, and then navigate to the location where you stored the certificate exported in the previous task. Enter the password specified when you exported the certificate, confirm it and then click the <strong>Tick</strong>.</p>

<p><img src="Images/creating-certificate-service.png?raw=true" alt="Creating a certificate for the service">
</p>

<p><em>Creating a certificate for the service</em></p></li>
</ol>

<p><a name="Ex4Task5" /></p>

<h4>Task 5 - Verification</h4>

<p>In this task, you will deploy the application to Windows Azure and access its HTTPS endpoint to verify that your enabled SSL successfully.</p>

<ol>
<li><p>Switch back to Visual Studio. If you closed the project, you will need to reopen it from <strong>Ex4-SecuringAppWithSSL\Begin</strong> in the <strong>Source</strong> folder of the lab.</p></li>
<li><p>In <strong>Solution Explorer</strong>, expand the <strong>Roles</strong> node in the <strong>MyTodo</strong> project, double-click the <strong>MyTodo.WebUx</strong> role to open its properties window, and then switch to the <strong>Settings</strong> tab.</p></li>
<li><p>Configure the storage account connection strings. To do this, expand the <strong>Roles</strong> node in the <strong>MyTodo</strong> project and double-click the <strong>MyTodo.WebUX</strong> role. In the role properties window, select the <strong>Settings</strong> tab and select <em>Cloud</em> from the <strong>Service Configuration</strong> drop-down list. Then select the <em>Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString</em> setting, ensure that the <strong>Type</strong> is set to <em>Connection String</em>, and then click the button labeled with an ellipsis.</p>

<p><img src="./Images/defining-connection-settings.png?raw=true" alt="Defining storage account connection settings" title="Defining storage account connection settings">
</p>

<p><em>Defining storage account connection settings</em></p></li>
<li><p>In the <strong>Storage Account Connection String</strong> dialog, select the <strong>Manually entered credentials</strong> option. Complete your storage <strong>Account Name</strong> and storage <strong>Account Key</strong> and click <strong>OK</strong>.</p>

<p><img src="./Images/defining-connection-settings-2.png?raw=true" alt="Configuring the storage account name and account key" title="Configuring the storage account name and account key">
</p>

<p><em>Configuring the storage account name and account key</em></p>
<blockquote>
<p><strong>Note:</strong> This information is available in the <strong>Dashboard</strong> section of your storage account in the Windows Azure Management Portal. You used the same settings in Exercise 1, when you deployed and configured the application. </p>
</blockquote></li>
<li><p>Press <strong>CTRL + S</strong> to save the changes.</p></li>
<li><p>Next, open the <strong>Web.config</strong> file located in the <strong>MyTodo.WebUx</strong> project. Update the <em>DefaultConnection</em> entry with the following highlighted code, replacing the placeholders with the <strong>SQL Database server</strong>, <strong>database name</strong>, <strong>login name</strong> and <strong>login password</strong> of your SQL database.</p>

<!--mark: 3-8-->

<pre><code class="XML">...
&lt;connectionStrings&gt;
    &lt;add name=&quot;DefaultConnection&quot; providerName=&quot;System.Data.SqlClient&quot;
        connectionString=&quot;Server=tcp:[YOUR_DATABASE_SERVER];
        Database=[YOUR_DATABASE_NAME];User ID=[YOUR_USER_NAME];
        Password=[YOUR_USER_PASSWORD];
        Trusted_Connection=False;
        Encrypt=True;Connection Timeout=30;&quot; /&gt;
&lt;/connectionStrings&gt;
...
</code></pre></li>
<li><p>Press <strong>CTRL + S</strong> to save the changes.</p></li>
<li><p>Publish and deploy the application once again to the Windows Azure environment using your preferred method, by choosing among the Windows Azure Developer Portal, the Windows Azure Service Management PowerShell Cmdlets, or the Windows Azure Tools for Visual Studio. Refer to Exercises 1, 2, and 3 for instructions on how to carry out the deployment with any of these methods.</p>
<blockquote>
<p><strong>Note:</strong> The service configuration now specifies an additional endpoint for HTTPS, therefore, you cannot simply upgrade the current deployment and instead, you need to re-deploy the application. This is mandatory whenever you change the topology of the service.</p>
</blockquote></li>
<li><p>Once you have deployed the application, wait until its status is shown as <strong>Running</strong> (or the deployment is shown as <strong>Completed</strong> when deploying with Visual Studio).</p></li>
<li><p>Now, browse to the HTTPS endpoint (e.g. <em><a href="https://servicemytodo.cloudapp.net">https://servicemytodo.cloudapp.net</a></em>). Once again, you will observe a certificate error because the certificate authority for the self-signed certificate is not trusted. You may ignore this error.</p>

<p><img src="Images/accessing-https-endpoint.png?raw=true" alt="Accessing the HTTPS endpoint in Windows Azure">
</p>

<p><em>Accessing the HTTPS endpoint in Windows Azure</em></p>
<blockquote>
<p><strong>Note:</strong> For your production deployments, you can purchase a certificate for your application from a trusted authority and use that instead.</p>
</blockquote></li>
</ol>

<p><a name="Ex4Task6" /></p>

<h4>Task 6 – Configuring a CNAME Entry for DNS Resolution (Optional)</h4>

<p>When you deploy your application, Windows Azure assigns it a URL of the form <em>http://[servicemytodo].cloudapp.net</em>, where [<em>servicemytodo</em>] is the public name that you chose for your cloud service at the time of creation. While this URL is completely functional, there are many reasons why you might prefer to use a URL in your own domain to access the service. In other words, instead of accessing the application as <em><a href="http://servicemytodo.cloudapp.net">http://servicemytodo.cloudapp.net</a></em>, use your own organization's domain name instead, for example <em><a href="http://servicemytodo.fabrikam.com">http://servicemytodo.fabrikam.com</a></em>.</p>

<p>One way to map the application to your own domain is to set up a CNAME record in your own DNS system pointing at the host name in Azure. A CNAME provides an alias for any host record, including hosts in different domains. Thus, to map the application to the <em>fabrikam.com</em> domain, you can create the following record in your DNS.</p>

<table><thead>
<tr>
<td><strong>Organization's domain</strong></td>
<td><strong>Alias</strong></td>
<td><strong>Application's domain</strong></td>
</tr>
</thead><tbody>
<tr>
<td>servicemytodo.fabrikam.com</td>
<td>CNAME</td>
<td>servicemytodo.cloudapp.net</td>
</tr>
</tbody></table>
<p>The procedure for doing this varies depending on the details of your DNS infrastructure. For external domain registrars, you can consult their documentation to find out the correct procedure for setting up a CNAME. For additional information on this topic, see <a href="http://blog.smarx.com/posts/custom-domain-names-in-windows-azure">Custom Domain Names in Windows Azure</a>.
As an example, this task briefly shows how you set up an alias using Microsoft DNS on Windows Server 2008. </p>
<blockquote>
<p><strong>Note:</strong> Windows DNS Server should be installed on the Windows Server 2008. You can enable the DNS Server role on the Server Manager.</p>
</blockquote>
<ol>
<li><p>Open DNS Manager from <strong>Start | Administrative Tools | DNS</strong>.</p></li>
<li><p>In DNS Manager, expand the <strong>Forward Lookup Zones</strong> node, then right-click the zone where you intend to set up the alias and select <strong>New Alias (CNAME)</strong>.Notice that if you do not have any zone, you must create one prior the alias creation.</p>

<p><img src="./Images/creating-alias.png?raw=true" alt="Updating a lookup zone to create an alias" title="Updating a lookup zone to create an alias">
</p>

<p><em>Updating a lookup zone to create an alias</em></p></li>
<li><p>In the <strong>New Resource Record</strong> dialog, enter the alias name that you would like to use to access the application hosted in Azure, for example, <em>servicemytodo</em>. Then, type in the fully qualified domain name of your application that Azure assigned to your application, for example, <em>[servicemytodo].cloudapp.net</em>. Click <strong>OK</strong> to create the record.</p>

<p><img src="./Images/creating-alias-app.png?raw=true" alt="Creating an alias for the myTODO application in Azure" title="Creating an alias for the myTODO application in Azure">
</p>

<p><em>Creating an alias for the myTODO application in Azure</em></p></li>
<li><p>In the DNS Manager console, review the contents of the updated zone to find the newly created CNAME record.</p>

<p><img src="./Images/lookup-zone-alias.png?raw=true" alt="Updated lookup zone showing the new alias for the application" title="Updated lookup zone showing the new alias for the application">
</p>

<p><em>Updated lookup zone showing the new alias for the application</em></p></li>
<li><p>Now, open a command prompt and type the following command to verify that the alias is set up correctly and maps to the address of the application in Windows Azure. </p>

<!--mark: 1-->

<pre><code class="CommandPrompt">nslookup &lt;youralias&gt;
</code></pre>

<p><img src="./Images/command-prompt-alias-verification.png?raw=true" alt="Verifying the domain alias" title="Verifying the domain alias">
</p>

<p><em>Verifying the domain alias</em></p>

<p>You will now be able to access the application using the alias.</p></li>
</ol>

<hr>

<p><a name="NextSteps" /></p>

<h2>Next Steps</h2>

<p>To learn more about deploying Cloud Services in Windows Azure, please refer to the following articles:</p>

<p><strong>Technical Reference</strong></p>

<p>This is a list of articles that expand on the technologies explained in this lab:</p>

<ul>
<li><p><a href="http://aka.ms/Jb4mkm">Use the Windows Azure SDK Tools to Package, Run, and Deploy an Application</a>: explores the tools in the Windows Azure SDK to run, test, debug, and fine-tune your application before you deploy it as a cloud service to Windows Azure.</p></li>
<li><p><a href="http://aka.ms/Ifhdz0">How to Monitor Cloud Services</a>: explains how to monitor key performance metrics for your cloud services in the Windows Azure Management Portal.</p></li>
<li><p><a href="http://aka.ms/Leav14">Debugging Cloud Services</a>: explores the different techniques provided by the Windows Azure Tools for Microsoft Visual Studio and the Windows Azure SDK to debug a Windows Azure application.</p></li>
<li><p><a href="http://aka.ms/Hy6l4h">Set Up a Remote Desktop Connection for a Role in Windows Azure</a>: after you create a cloud service that is running your application, you can remotely access a role instance to configure settings in the virtual machine or troubleshoot issues.</p></li>
<li><p><a href="http://aka.ms/Aoxmbq">Run Startup Tasks in Windows Azure</a>: you can use startup tasks to perform operations before a role starts. Operations that you might want to perform include installing a component, registering COM components, setting registry keys, or starting a long running process.</p></li>
<li><p><a href="http://aka.ms/Tydm1x">Configure an SSL Certificate on an HTTPS Endpoint</a>: enumerates the steps to add an HTTPS endpoint to a role in your Windows Azure service and associate it with an SSL certificate.</p></li>
</ul>

<p><strong>Development</strong></p>

<p>This is a list of developer-oriented articles related to deploying Cloud Services in Windows Azure:</p>

<ul>
<li><a href="http://aka.ms/G9j3a3">Windows Azure Management Cmdlets Reference</a>: describes the cmdlet in the .7.1 version of the Windows Azure PowerShell module. Windows Azure PowerShell is the module for Windows PowerShell that you can use to control and automate the deployment and management of your workloads in Windows Azure.</li>
</ul>

<hr>

<p><a name="Summary" /></p>

<h2>Summary</h2>

<p>By completing this hands-on lab, you learnt how to create a storage account, a SQL database and a cloud service at the Windows Azure Management Portal. Using the management portal, you deployed a service package that contained the application binaries, configured its storage and defined the number of instances to run. </p>

<p>You also saw how to achieve this programmatically using the Service Management API and in particular, how to use the Windows Azure Service Management cmdlets to deploy, update, and manage applications using Windows PowerShell.</p>

<p>As a developer, you saw how to use Windows Azure Tools in Visual Studio to publish your solution in the background, while you continue with your development tasks.
Finally, you learnt how to upload certificates using the management portal and use SSL to secure your Windows Azure application.</p>
