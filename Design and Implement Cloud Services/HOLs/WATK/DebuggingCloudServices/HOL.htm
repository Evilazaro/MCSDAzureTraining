<p><a name="HOLTop"></a></p>

<h1>Debugging Applications in Windows Azure</h1>

<hr>

<p><a name="Overview"></a></p>

<h2>Overview</h2>

<p>Using Visual Studio, you can debug applications in your local machine by stepping through code, setting breakpoints, and examining the value of program variables. For Windows Azure applications, the compute emulator allows you to run the code locally and debug it using these same features and techniques, making this process relatively straightforward.</p>

<p>Ideally, you should take advantage of the compute emulator and use Visual Studio to identify and fix most bugs in your code, as this provides the most productive environment for debugging. Nevertheless, some bugs might remain undetected and will only manifest themselves once you deploy the application to the cloud. These are often the result of missing dependencies or caused by differences in the execution environment. The tools in Visual Studio can help you debug these errors if you enable remote debugging when you publish your service and then attach the debugger to a role instance.</p>

<p>However, there are some scenarios for which you should not use remote debugging. For example, if you start a remote debugging session with a cloud service hosted in a production environment, clients using the production service might be adversely affected. Instead, you need to rely on debugging information written to logs in order to diagnose and troubleshoot application failures. Windows Azure provides comprehensive diagnostic facilities that allow you to capture information from different sources, including Windows Azure application logs, IIS logs, failed request traces, Windows event logs, custom error logs, and crash dumps. The availability of this diagnostic information relies on the Windows Azure Diagnostics Monitor to collect data from individual role instances and transfer this information to Windows Azure storage for aggregation. Once the information is in storage, you can retrieve it and analyze it.</p>

<p>Sometimes an application may crash before it is able to produce logs that can help you determine the cause of the failure. With <strong>IntelliTrace</strong> debugging, a feature available in the Visual Studio 2013 Ultimate edition, you can log extensive debugging information for a role instance while it is running in Windows Azure. This lab shows you how to enable IntelliTrace for an Azure deployment to debug role start up failures.</p>

<p><a name="Objectives"></a></p>

<h3>Objectives</h3>

<p>In this hands-on lab, you will learn how to:</p>

<ul>
<li>Use different features available in Visual Studio 2013 to debug cloud services</li>
<li>Use Windows Azure Diagnostics to collect diagnostics data in a table storage and learn how to retrieve those logs from Visual Studio</li>
<li>Enable and use IntelliTrace to trace and debug applications</li>
</ul>

<p><a name="Prerequisites"></a></p>

<h3>Prerequisites</h3>

<p>The following is required to complete this hands-on lab:</p>

<ul>
<li><p><a href="http://www.visualstudio.com/downloads/download-visual-studio-vs">Visual Studio Professional 2013</a> or higher</p></li>
<li><p><a href="http://www.microsoft.com/windowsazure/sdk/">Windows Azure Tools for Microsoft Visual Studio 2.2</a> or later</p></li>
<li><p>A Windows Azure subscription</p>

<ul>
<li>Sign up for a <a href="http://aka.ms/watk-freetrial">Free Trial</a></li>
<li>If you are a Visual Studio Professional, Test Professional, Premium or Ultimate with MSDN or MSDN Platforms subscriber, activate your <a href="http://aka.ms/watk-msdn">MSDN benefit</a> now to start developing and testing on Windows Azure.</li>
<li><a href="http://aka.ms/watk-bizspark">BizSpark</a> members automatically receive the Windows Azure benefit through their Visual Studio Ultimate with MSDN subscriptions.</li>
<li>Members of the <a href="http://aka.ms/watk-mpn">Microsoft Partner Network</a> Cloud Essentials program receive monthly Windows Azure credits at no charge.</li>
</ul></li>
</ul>
<blockquote>
<p><strong>Note:</strong> This lab was designed for Windows 8.</p>
</blockquote>
<p><a name="Setup"/></p>

<h3>Setup</h3>

<p>In order to execute the exercises in this hands-on lab, you will need to set up your environment.</p>

<ol>
<li><p>Open a Windows Explorer window and browse to the lab's <strong>Source</strong> folder.</p></li>
<li><p>Right-click the <strong>Setup.cmd</strong> file and click <strong>Run as administrator</strong>. This will launch the setup process that will install the Visual Studio code snippets for this lab.</p></li>
<li><p>If the User Account Control dialog box is shown, confirm the action to proceed.</p></li>
</ol>
<blockquote>
<p><strong>Note:</strong> Make sure you have checked all the dependencies for this lab before running the setup.</p>
</blockquote>
<p><a name="UsingCodeSnippets"/></p>

<h3>Using the Code Snippets</h3>

<p>Throughout the lab document, you will be instructed to insert code blocks. For your convenience, most of that code is provided as Visual Studio Code Snippets, which you can access from within Visual Studio 2013 to avoid having to add it manually.</p>

<hr>

<p><a name="Exercises"/></p>

<h2>Exercises</h2>

<p>This hands-on lab includes the following exercises:</p>

<ol>
<li><a href="#Exercise1">Debugging a Cloud Service in Visual Studio</a></li>
<li><a href="#Exercise2">Adding Diagnostic Trace</a></li>
<li><a href="#Exercise3">Using IntelliTrace to Diagnose Role Start-Up Failures</a> (Optional for Visual Studio 2013 Ultimate edition)</li>
</ol>

<p>Estimated time to complete this lab: <strong>40 minutes</strong>.</p>

<p><a name="Exercise1"></a></p>

<h3>Exercise 1: Debugging a Cloud Service in Visual Studio</h3>

<p>In this exercise, you will debug a simple cloud service application locally from Visual Studio by using the Windows Azure compute emulator. Then, you will learn how to use the Visual Studio tools to attach the debugger to the application when it is running in Windows Azure.</p>

<p>The cloud service application you will use for this exercise simulates an online auto insurance policy calculator. It has a single form where users can enter details about their vehicle and then submit the form to obtain an estimate on their insurance premium. Behind the scenes, the controller action that processes the form uses a separate assembly to calculate premiums based on the input from the user. The assembly contains a bug that causes it to raise an exception for input values that fall outside the expected range.</p>

<p><a name="Ex1Task1"></a></p>

<h4>Task 1 - Debugging the Fabrikam Insurance Application on the Local Computer</h4>

<p>In this task, you will build and run the Fabrikam Insurance application in the Windows Azure compute emulator so you can test and debug the cloud service before you deploy it.</p>

<ol>
<li><p>Open Visual Studio in elevated administrator mode by right-clicking the <strong>Microsoft Visual Studio Professional 2013</strong> shortcut and choosing <strong>Run as administrator</strong>.</p></li>
<li><p>In the <strong>File</strong> menu, click <strong>Open | Project/Solution...</strong>, browse to <strong>Ex1-DebuggingInVisualStudio</strong> in the <strong>Source</strong> folder of the lab, select <strong>Begin.sln</strong> in the <strong>Begin</strong> folder and then click <strong>Open</strong>.</p></li>
<li><p>Set the start action of the project. To do this, in <strong>Solution Explorer</strong>, right-click the <strong>FabrikamInsurance</strong> project and then select <strong>Properties</strong>. In this window, switch to the <strong>Web</strong> tab and then, under <strong>Start Action</strong>, select the <strong>Specific Page</strong> option. Leave the page value blank, and save the changes.</p>

<p><img src="Images/configuring-the-start-action-of-the-project.png?raw=true" alt="Configuring the start action of the project" title="Configuring the start action of the project">
</p>

<p><em>Configuring the start action of the project</em></p></li>
<li><p>Configure the cloud project <strong>FabrikamInsurance.Azure</strong> as the StartUp Project. To do this, in <strong>Solution Explorer</strong> right-click the <strong>FabrikamInsurance.Azure</strong> project node and then select <strong>Set as StartUp Project</strong>.</p>

<p><img src="Images/configuring-startup-project.png?raw=true" alt="Configuring StartUp project">
</p>

<p><em>Configuring StartUp project</em></p></li>
<li><p>You are now ready to test the Windows Azure Project application. To launch the application in the compute emulator, press <strong>F5</strong>. Wait until deployment has completed and you see the <strong>Auto Insurance Quotes</strong> form open in the browser.</p></li>
<li><p>To explore its operation, complete the form by choosing any combination of values from the drop-down lists and then click <strong>Calculate</strong> to obtain a quote for the insurance premium. Notice that after you submit the form, the page refreshes and shows the calculated amount.</p>

<p><img src="Images/exploring-the-fabrikam-insurance-application.png?raw=true" alt="Exploring the Fabrikam Insurance application" title="Exploring the Fabrikam Insurance application">
</p>

<p><em>Exploring the Fabrikam Insurance application</em></p></li>
<li><p>Once you have verified that everything works in the compute emulator, you will now cause an exception by forcing the application to process bad data it cannot handle correctly. To do this, change the values used for the calculation by setting the <strong>Make</strong> to &quot;<em>PORSCHE&quot;</em> and the <strong>Model</strong> to &quot;<em>BOXSTER (BAD DATA)&quot;</em>.</p>

<p><img src="Images/choosing-make-and-model-for-the-insurance-premium-calculation.png?raw=true" alt="Choosing make and model for the insurance premium calculation" title="Choosing make and model for the insurance premium calculation">
</p>

<p><em>Choosing make and model for the insurance premium calculation</em></p></li>
<li><p>Click <strong>Calculate</strong> to resubmit the form with the new values. Notice that an unhandled exception occurs and execution halts in the Visual Studio debugger at the line that caused the error. </p>

<p><img src="Images/unhandled-exception-in-the-application-caused-by-bad-data.png?raw=true" alt="Unhandled exception in the application caused by bad data" title="Unhandled exception in the application caused by bad data">
</p>

<p><em>Unhandled exception in the application caused by bad data</em></p>
<blockquote>
<p><strong>Note:</strong> Within the Visual Studio debugger, you are able to step through code, set breakpoints, and examine the value of program variables. Debugging applications hosted in the compute emulator provides the same experience that you typically have when debugging other programs to which you can attach the Visual Studio debugger. Using the debugger under these conditions will not be explored here. For more information, see <a href="http://msdn.microsoft.com/en-us/library/sc65sadd.aspx">Debugging in Visual Studio</a>.</p>
</blockquote></li>
<li><p>Press <strong>F5</strong> to continue execution and let ASP.NET handle the exception. Notice that the exception handler provides details about the exception, including the line in the source code that raised the exception. </p>

<p><img src="Images/aspnet-default-unhandled-exception-handler.png?raw=true" alt="ASP.NET default unhandled exception handler" title="ASP.NET default unhandled exception handler ">
</p>

<p><em>ASP.NET default exception handler</em></p>
<blockquote>
<p><strong>Note:</strong> Unhandled exceptions are typically handled by ASP.NET, which can report the error in its response, including details and the location in the source code where the exception was raised. However, for applications that are available publicly, exposing such information is not recommended in order to prevent unnecessary disclosure of internal details about the application that may compromise its security. Instead, errors and other diagnostics output should be written to a log that can only be retrieved after proper authorization. </p>

<p>You can configure how information is displayed by ASP.NET when an unhandled error occurs during the execution of a Web request. </p>

<p>In this case, the unhandled exception error page includes full details of the error because the default mode for the <strong>customErrors</strong> element is <em>remoteOnly</em> and you are accessing the page locally. When you deploy the application to the cloud and access it remotely, the page shows a generic error message instead.</p>
</blockquote></li>
<li><p>Go back to Visual Studio and press <strong>SHIFT + F5</strong> to stop debugging and shut down the application.</p></li>
</ol>

<p><a name="Ex1Task2"></a></p>

<h4>Task 2 - Debugging the Fabrikam Insurance Application in Windows Azure</h4>

<p>In this task, you will deploy the Fabrikam insurance application to Windows Azure and enable remote debugging when publishing the service. This will allow you to attach the Visual Studio debugger to the deployed cloud service.</p>

<ol>
<li><p>In <strong>Solution Explorer</strong>, right-click the <strong>FabrikamInsurance.Azure</strong> cloud project and select <strong>Publish...</strong>.
In the <strong>Publish Windows Azure Application</strong> dialog box, click <strong>Sign In</strong> and sign in using the Microsoft account associated with your Windows Azure account. </p>

<p><img src="Images/sign-in-to-see-your-subscriptions.png?raw=true" alt="Sign in to see your subscriptions">
</p>

<p><em>Sign in to see your subscriptions</em></p></li>
<li><p>The subscription drop-down list will be populated with your subscriptions. Select a subscription and click <strong>Next</strong>.</p></li>
<li><p>In the <strong>Common Settings</strong> tab, click the drop down list labeled <strong>Cloud Service</strong> and select <strong>&lt;Create New...&gt;</strong>. Enter the name for your cloud service (e.g. <em>fabrikaminsuranceservice</em>), select the location of the service and click <strong>OK</strong>.</p>

<p><img src="Images/create-the-cloud-service.png?raw=true" alt="Create the cloud service">
</p>

<p><em>Create the cloud service</em></p></li>
<li><p>In the <strong>Common Settings</strong> tab, make sure the cloud service you just created is selected. Click the drop-down list labeled <strong>Build configuration</strong> and select <strong>Debug</strong>.</p>
<blockquote>
<p><strong>Note:</strong> For simplicity, you will debug the cloud service deployed to the <strong>Production</strong> environment. In a real-world scenario, you should work in the <strong>Staging</strong> environment when performing remote debugging.</p>
</blockquote>
<p><img src="Images/deployment-common-settings-debugging.png?raw=true" alt="Deployment common settings">
</p>

<p><em>Deployment common settings</em></p></li>
<li><p>Click the <strong>Advanced Settings</strong> tab. In the list labeled <strong>Storage account</strong> select <strong>&lt;Create New...&gt;</strong>. Enter the name of your storage service (e.g. <em>fabrikaminsurancestorage</em>), select the location you selected for the cloud service and click <strong>OK</strong>.</p>

<p><img src="Images/create-the-storage-account.png?raw=true" alt="Create the storage account">
</p>

<p><em>Create the storage account</em></p></li>
<li><p>Make sure the storage service you just created is selected. Then, select the check box labeled <strong>Enable Remote Debugger for all roles</strong> and click <strong>Next</strong>.</p>

<p><img src="Images/deployment-advanced-settings-debugging.png?raw=true" alt="Deployment advanced settings">
</p>

<p><em>Deployment advanced settings</em></p></li>
<li><p>Make sure the Summary information is correct, and click <strong>Publish</strong> to start the deployment process.</p>

<p><img src="Images/starting-deployment-debugging.png?raw=true" alt="Starting deployment">
</p>

<p><em>Starting deployment</em></p></li>
<li><p>After you start deployment, you can examine the Windows Azure activity log window to see the status of the operation. If this window is not visible, in the <strong>View</strong> menu, point to <strong>Other Windows</strong> and select <strong>Windows Azure Activity Log</strong>. Then, click on the operation.</p>

<p><img src="Images/windows-azure-activity-log-debugging.png?raw=true" alt="Windows Azure Activity Log">
</p>

<p><em>Windows Azure Activity Log</em></p></li>
<li><p>You can examine the <strong>History</strong> panel to see more details about the status of the deployment. Wait until you see a <strong>Complete</strong> message.</p>

<p><img src="Images/deployment-completed-debugging.png?raw=true" alt="Deployment completed">
</p>

<p><em>Deployment completed</em></p></li>
<li><p>In the <strong>Windows Azure Activity Log</strong> window, click <strong>Open in Server Explorer</strong> under the deployment entry of your cloud service.</p>

<p><img src="Images/viewing-the-cloud-service-in-server-explorer.png?raw=true" alt="Viewing the cloud service in Server Explorer">
</p>

<p><em>Viewing the cloud service in Server Explorer</em></p></li>
<li><p>In the <strong>Windows Azure</strong> node in <strong>Server Explorer</strong>, right-click the node labeled as <strong>FabrikamInsurance</strong>, and then select <strong>Attach Debugger</strong>. </p>

<p><img src="Images/attach-the-debugger-to-the-role.png?raw=true" alt="Attach the debugger to the role">
</p>

<p><em>Attach the debugger to the role</em></p>
<blockquote>
<p><strong>Note:</strong> When you select a role, the Visual Studio debugger attaches itself to each instance of that role. The debugger will break on a breakpoint for the first role instance that runs that line of code and meets any conditions of that breakpoint. If you select an instance, the debugger attaches to only that instance and breaks on a breakpoint only when that specific instance runs that line of code and meets the breakpoint's conditions.</p>
</blockquote></li>
<li><p>The debugger automatically attaches to the appropriate host process for your role. Depending on what the role is, the debugger attaches to w3wp.exe, WaWorkerHost.exe, or WaIISHost.exe. To verify the process to which the debugger is attached, expand the instance node in <strong>Server Explorer</strong>.</p>

<p><img src="Images/process-the-debugger-is-attached-to.png?raw=true" alt="Processes to which the debugger is attached">
</p>

<p><em>Processes to which the debugger is attached</em></p>
<blockquote>
<p><strong>Note:</strong> To identify the processes to which the debugger is attached, open the <strong>Debug</strong> menu option, point to to <strong>Windows</strong> and select <strong>Processes</strong>.</p>
</blockquote></li>
<li><p>Open a browser window, and navigate to <strong>http://[your-cloud-service-name].cloudapp.net/</strong>. Complete the form, making sure that you select &quot;<em>PORSCHE&quot;</em> for the <strong>Make</strong> of the vehicle and &quot;<em>BOXSTER (BAD DATA)</em>&quot; for the <strong>Model</strong>.</p></li>
<li><p>Just like in the local scenario, an unhandled exception occurs and execution halts in the Visual Studio debugger at the line that caused the error. But this time, Visual Studio is debugging the code running in the remote process.</p>

<p><img src="Images/unhandled-exception-in-the-application-caused-by-bad-data.png?raw=true" alt="Unhandled exception in the deployed application">
</p>

<p><em>Unhandled exception in the deployed application</em></p>
<blockquote>
<p><strong>Note:</strong> After the debugger attaches to a role or an instance, you can debug as usual. However, you should avoid long stops at breakpoints when remote debugging because Windows Azure treats a process that is stopped for longer than a few minutes as unresponsive and stops sending traffic to that instance. If you stop for too long, the Remote Debugging Monitor (<em>msvsmon</em>.<em>exe</em>) that runs on your role instance shuts down and terminates your debugging session.</p>
</blockquote></li>
<li><p>Press <strong>F5</strong> to continue execution and let ASP.NET handle the exception. Notice that this time the application shows a generic error page instead of the exception details that you saw earlier when running the application locally. This is because the default mode for the <strong>customErrors</strong> element is <em>remoteOnly</em>, and the application is now running in Windows Azure.</p>

<p><img src="Images/generic-error-page.png?raw=true" alt="Generic error page">
</p>

<p><em>Generic error page</em></p></li>
<li><p>To detach the debugger from all processes in your instance or role, go back to Visual Studio and press <strong>SHIFT + F5</strong>, or right-click the role or instance node you are debugging in <strong>Server Explorer</strong> and select <strong>Detach Debugger</strong>.</p></li>
</ol>

<p><a name="Exercise2"></a></p>

<h3>Exercise 2: Adding Diagnostic Trace</h3>

<p>Because Windows Azure Diagnostics is oriented towards operational monitoring and has to cater for gathering information from multiple role instances, it requires diagnostic data to first be transferred from local storage in each role to Windows Azure storage, where it is aggregated. The Diagnostics Monitor -a process running on your role instances- then performs scheduled transfers to copy logging data to Windows Azure storage at regular intervals.</p>

<p>In this exercise, you will debug the Fabrikam insurance application by configuring Windows Azure Diagnostics. To produce diagnostic data, you will instrument the application to write its trace information using standard methods in the System.Diagnostics namespace. Finally, you will take advantage of the tools provided by Visual Studio to retrieve and display the contents of the diagnostics table.</p>

<p><a name="Ex2Task1"></a></p>

<h4>Task 1 - Adding Tracing Support to the Application</h4>

<p>To debug the application once you deploy it to a production environment, you should write debugging information to the logs in order to diagnose an application failure.</p>

<p>In this task, you will configure Windows Azure Diagnostics in the Fabrikam Insurance application and instrument the application to trace diagnostics data.</p>

<ol>
<li><p>If not already open, open Visual Studio in elevated administrator mode by right-clicking the <strong>Microsoft Visual Studio Professional 2013</strong> shortcut and choosing <strong>Run as administrator</strong>.</p></li>
<li><p>In the <strong>File</strong> menu, click <strong>Open | Project/Solution...</strong>, browse to <strong>Ex2-AddingDiagnosticTrace</strong> in the <strong>Source</strong> folder of the lab, select <strong>Begin.sln</strong> in the <strong>Begin</strong> folder and then click <strong>Open</strong>.</p>
<blockquote>
<p><strong>Note:</strong> Alternatively you can continue working with the solution obtained after completing the previous exercise.</p>
</blockquote></li>
<li><p>In <strong>Solution Explorer</strong>, right-click the <strong>FabrikamInsurance</strong> role located in the <strong>FabrikamInsurance.Azure</strong> project and select <strong>Properties</strong>. Click the <strong>Configuration</strong> tab.</p>

<p><img src="Images/opening-properties-for-the-role.png?raw=true" alt="Opening properties for the role" title="Opening properties for the role">
</p>

<p><em>Opening properties for the role</em></p></li>
<li><p>In the <strong>Diagnostics</strong> section, make sure that the <strong>Enable Diagnostics</strong> check box is selected.</p>

<p><img src="Images/making-sure-that-diagnostics-are-enabled.png?raw=true" alt="Making sure diagnostics are enabled" title="Making sure that diagnostics are enabled">
</p>

<p><em>Making sure diagnostics are enabled</em></p></li>
<li><p>To customize the settings, select the <strong>Custom plan</strong> option, and then click <strong>Edit</strong>.</p>
<blockquote>
<p><strong>Note:</strong> Among the available options (<strong>Errors only</strong>, <strong>All information</strong>, and <strong>Custom plan</strong>), <strong>Errors only</strong> is the default option and requires the least amount of storage because it doesnâ€™t transfer warnings or tracing messages. The option <strong>All information</strong> transfers the most information and is therefore the most expensive option.</p>
</blockquote>
<p><img src="Images/selecting-the-custom-plan.png?raw=true" alt="Selecting the custom plan" title="Selecting the custom plan">
</p>

<p><em>Selecting the custom plan</em></p></li>
<li><p>In the <strong>Application logs</strong> tab of the <strong>Diagnostics configuration</strong> dialog box, select <strong>All</strong> as the <strong>Log level</strong> in order to log all trace messages (not only the application errors).</p>

<p><img src="Images/selecting-the-all-log-level-for-application-l.png?raw=true" alt="Selecting the All log level for Application logs" title="Selecting the All log level for Application logs">
</p>

<p><em>Selecting the All log level for Application logs</em></p></li>
<li><p>Make sure that the <strong>Transfer period</strong> is set to <strong>1 minute</strong>. The Diagnostic Monitor will transfer the application logs from the role instances to Windows Azure storage in this time interval.</p>

<p><img src="Images/application-logs-transfer-period.png?raw=true" alt="Application logs transfer period">
</p>

<p><em>Selecting the Transfer period for Application logs</em></p></li>
<li><p>Click <strong>OK</strong> to close the dialog box.</p></li>
<li><p>To instrument the application and write diagnostics information to the error log, add a global error handler to the application. To do this, open the <strong>Global.asax.cs</strong> file located in the <strong>FabrikamInsurance</strong> project and insert the following method into the <strong>MVCApplication</strong> class.</p>

<p>(Code Snippet - WindowsAzureDebugging-Ex2-Application_Error-CS)</p>

<!-- mark:5-9 -->

<pre><code class="C#">public class MvcApplication : System.Web.HttpApplication
{
  ...

  protected void Application_Error()
  {
    var lastError = Server.GetLastError();
    System.Diagnostics.Trace.TraceError(lastError.Message);
  }
}
</code></pre>
<blockquote>
<p><strong>Note:</strong> The <strong>Application_Error</strong> event is raised to catch any unhandled ASP.NET errors while processing a request. The event handler shown above retrieves a reference to the unhandled exception object using <strong>Server.GetLastError</strong> and then uses the <strong>TraceError</strong> method of the <strong>System.Diagnostics.Trace</strong> class to log the error message. </p>

<p>Note that the <strong>Trace</strong> object outputs the message to each listener in its <strong>Listeners</strong> collection, which by default contains an instance of the <strong>DefaultTraceListener</strong> class. The role project templates provided by the Windows Azure Tools for Microsoft Visual Studio already include the settings required in the <strong>Web.config</strong> or <strong>App.config</strong> file  of the role to use the <strong>DiagnosticMonitorTraceListener</strong> to write to the Windows Azure diagnostics log. When using this type of trace listener, the logs are gathered locally in each role. The Diagnostic Monitor then copies the information to the storage service account configured in the <em>ServiceConfiguration.cscfg</em> file (transferred trace data is located in the <em>WADLogsTable</em> of the storage account).</p>
</blockquote></li>
<li><p>Open the <strong>QuoteController.cs</strong> file in the <strong>Controllers</strong> folder of the <strong>FabrikamInsurance</strong> project and add the following method into the <strong>QuoteController</strong> class. </p>

<p>(Code Snippet - WindowsAzureDebugging-Ex2-Controller OnException method-CS)</p>

<!-- mark:6-9 -->

<pre><code class="C#">[HandleError]
public class QuoteController : Controller
{
  ...

  protected override void OnException(ExceptionContext filterContext)
  {
    System.Diagnostics.Trace.TraceError(filterContext.Exception.Message);
  }
}
</code></pre>
<blockquote>
<p><strong>Note:</strong> The <strong>OnException</strong> method is called when an unhandled exception occurs during the processing of an action in a controller. For MVC applications, unhandled errors are typically caught at the controller level, provided they occur during the execution of a controller action and that the action (or controller) has been decorated with a <strong>HandleErrorAttribute</strong>. To log exceptions in controller actions, you need to override the <strong>OnException</strong> method of the controller because the <strong>Application_Error</strong> is bypassed when the error-handling filter catches the exceptions. </p>

<p>By default, when an action method with the <strong>HandleErrorAttribute</strong> attribute throws an exception, MVC displays the <strong>Error</strong> view that is located in the <strong>~/Views/Shared</strong> folder.</p>
</blockquote></li>
<li><p>In addition to error logging, tracing can also be useful to record other significant events during the execution of the application; for example, to register when a given controller action is invoked. To show this feature, insert the following (highlighted) tracing statement at the start of the <strong>Calculator</strong> method to log a message when this action is called. </p>

<!-- mark:7 -->

<pre><code class="C#">public class QuoteController : Controller
{
  ...

  public ActionResult Calculator()
  {
    System.Diagnostics.Trace.TraceInformation(&quot;Calculator called...&quot;);
    QuoteViewModel model = new QuoteViewModel();
    this.PopulateViewModel(model, null);
    return this.View(model);
  }

  ...
}
</code></pre></li>
<li><p>Similarly, add a tracing statement to the <strong>About</strong> action, as shown (highlighted) below.</p>

<!-- mark:7 -->

<pre><code class="C#">public class QuoteController : Controller
{
  ...

  public ActionResult About()
  {
    System.Diagnostics.Trace.TraceInformation(&quot;About called...&quot;);
    return this.View();
  }

  ...
}
</code></pre></li>
</ol>

<p><a name="Ex2Task2"></a></p>

<h4>Task 2 - Verification</h4>

<p>You are now ready to redeploy and run the solution in Windows Azure. At this point, the application is ready for tracing and configured to collect and transfer all its diagnostics output to a table in storage services. You will use the Visual Studio tools to examine the diagnostics data generated by the application.</p>

<ol>
<li><p>Deploy the application again, making sure to select the cloud service and the storage account created in Exercise 1.</p>
<blockquote>
<p><strong>Note:</strong> Because the slot that you chose is already occupied by the previous deployment, Visual Studio will warn you and ask for confirmation before replacing it. Click <strong>Replace</strong> to overwrite the current deployment.</p>

<p><img src="Images/replacing-the-current-deployment.png?raw=true" alt="Replacing the current deployment" title="Replacing the current deployment">
</p>

<p><em>Replacing the current deployment</em> </p>
</blockquote></li>
<li><p>Wait until the deployment completes and navigate to the deployed cloud service. In the browser window, complete the form making sure that you select &quot;<em>PORSCHE&quot;</em> for the <strong>Make</strong> of the vehicle and &quot;<em>BOXSTER (BAD DATA)</em>&quot; for the <strong>Model</strong>. The generic error page should be displayed.</p></li>
<li><p>Switch back to Visual Studio, open <strong>Server Explorer</strong> and right-click the <strong>FabrikamInsurance</strong> role instance under the <strong>Cloud Services</strong> node. Then select <strong>View Diagnostics Data</strong>.</p>

<p><img src="Images/clicking-view-diagnostics-data.png?raw=true" alt="Clicking View Diagnostics Data" title="Clicking View Diagnostics Data">
</p>

<p><em>Clicking View Diagnostics Data</em></p></li>
<li><p>In the <strong>Diagnostics summary</strong> window, expand the <strong>Windows Azure application logs</strong> section in order to see the list of messages. A log entry corresponding to the error message for the unhandled exception should appear. If the error message is not yet displayed, you might have to wait for the transfer period to elapse and then <strong>Refresh</strong> to update the log list.</p>

<p><img src="Images/showing-the-error-trace-message.png?raw=true" alt="Showing the error trace message in the Diagnostics summary" title="Showing the error trace message in the Diagnostics summary">
</p>

<p><em>Showing the exception message in the Diagnostics summary</em></p></li>
<li><p>To view the output from other informational trace messages, return to the browser window and click <strong>About</strong> followed by <strong>Quotes</strong> to execute both actions in the controller. Keep in mind that you inserted trace messages at the start of each method.</p></li>
<li><p>Go back to the <strong>Diagnostics Summary</strong> report. Note that you will not see new entries since only errors are displayed in the summary. In order to see the informational trace messages you need to click <strong>View all data</strong> below the <strong>Windows Azure application logs</strong> table.</p>

<p><img src="Images/clicking-view-all-data.png?raw=true" alt="Clicking View all data" title="Clicking View all data">
</p>

<p><em>Clicking View all data</em></p></li>
<li><p>The <strong>Windows Azure Storage Table</strong> viewer should open, loading the content of the <strong>WADLogsTable</strong> table. Locate the log entries with the information trace messages. If the information messages are not yet displayed, you might have to wait for the transfer period to elapse and then click the <strong>Refresh</strong> icon from the toolbar to reload the table contents.</p>

<p><img src="Images/showing-informational-trace-messages.png?raw=true" alt="Showing informational trace messages for the controller actions">
</p>

<p><em>Showing informational trace messages for the controller actions</em></p></li>
</ol>

<p><a name="Exercise3"></a></p>

<h3>Exercise 3: Using IntelliTrace to Diagnose Role Start-Up Failures</h3>
<blockquote>
<p><strong>Note:</strong> This exercise is optional since IntelliTrace is only available for <strong>Visual Studio 2013 Ultimate</strong>. For more information on specific Visual Studio 2013 features, you can compare versions <a href="http://www.microsoft.com/visualstudio/eng/products/compare">here</a>.</p>
</blockquote>
<p>IntelliTrace provides the ability to collect data about an application while it is executing. When you enable IntelliTrace, it records key code execution and environment data and then allows you to replay this data from within Visual Studio, stepping through the same code that executes in the cloud.</p>

<p>When you deploy a service to Windows Azure from within Visual Studio, you can enable IntelliTrace debugging to package the necessary IntelliTrace files along with an agent that Visual Studio will communicate with to retrieve the IntelliTrace data. Once enabled, IntelliTrace operates in the background, collecting information about the running service.</p>

<p>You can customize the basic IntelliTrace configuration specifying which events to log, whether to collect call information, which modules and processes to collect logs for, and how much space to allocate to the recording (the default size being 250 MB).</p>

<p>The collected information is saved to an IntelliTrace file, which you can open later to start troubleshooting the problem. This information lets you step back in time to see what happened in the application and which events led to a crash.</p>

<p>In this exercise, you will explore the use of IntelliTrace to diagnose a role start-up failure while deploying the Fabrikam Insurance application to Windows Azure.</p>
<blockquote>
<p><strong>Note:</strong> IntelliTrace debugging is intended for debug scenarios only and should not be used for a production deployment. </p>
</blockquote>
<p><a name="Ex3Task1"></a></p>

<h4>Task 1 - Deploying the Application with IntelliTrace Enabled</h4>

<p>In this task, you will publish the FabrikamInsurance application to Windows Azure directly from Visual Studio with the IntelliTrace feature enabled.</p>

<ol>
<li><p>Open <strong>Microsoft Visual Studio Ultimate 2013</strong>.</p></li>
<li><p>In the <strong>File</strong> menu, click <strong>Open | Project/Solution...</strong> and browse to <strong>Ex3-DebuggingWithIntelliTrace\Begin</strong> in the <strong>Source</strong> folder of the lab. Select <strong>Begin.sln</strong> and click <strong>Open</strong>.</p></li>
<li><p>In the <strong>Solution Explorer</strong>, right-click the <strong>FabrikamInsurance.Azure</strong> cloud project and select <strong>Publish...</strong>.</p>

<p><img src="Images/publishing-the-fabrikaminsuranceazure-project.png?raw=true" alt="Publishing the FabrikamInsurance.Azure project" title="Publishing the FabrikamInsurance.Azure project">
</p>

<p><em>Publishing the FabrikamInsurance.Azure project</em></p></li>
<li><p>In the <strong>Common Settings</strong> tab, select the cloud service that you created during the first exercise of this lab.</p>

<p><img src="Images/deployment-common-settings.png?raw=true" alt="Deployment Common Settings" title="Deployment Common Settings">
</p>

<p><em>Deployment Common Settings</em></p></li>
<li><p>Click the <strong>Advanced Settings</strong> tab. In the list labeled <strong>Storage account</strong> select the storage service that you created during the first exercise of this lab. Select the box labeled <strong>Enable IntelliTrace</strong> and click <strong>Next</strong>.</p>

<p><img src="Images/deployment-advanced-settings.png?raw=true" alt="Deployment Advanced Settings" title="Deployment Advanced Settings">
</p>

<p><em>Deployment Advanced Settings</em></p></li>
<li><p>Review the Summary information. If all the information appears to be correct, click <strong>Publish</strong> to start the deployment process.</p>

<p><img src="Images/start-deployment.png?raw=true" alt="Starting Deployment" title="Starting Deployment">
</p>

<p><em>Starting Deployment</em></p>
<blockquote>
<p><strong>Note:</strong> Because the slot that you chose is already occupied by the previous deployment, Visual Studio warns you and asks for confirmation before replacing it. Click <strong>Replace</strong> to overwrite the current deployment.</p>

<p><img src="Images/replacing-the-current-deployment.png?raw=true" alt="Replacing the current deployment" title="Replacing the current deployment">
</p>

<p><em>Replacing the current deployment</em> </p>
</blockquote></li>
<li><p>After you start a deployment, you can examine the Windows Azure activity log window to determine the status of the operation. If this window is not visible, in the <strong>View</strong> menu, point to <strong>Other Windows</strong> and select <strong>Windows Azure Activity Log</strong>.</p>

<p><img src="Images/azure-activity-log.png?raw=true" alt="Windows Azure Activity Log" title="Windows Azure Activity Log">
</p>

<p><em>Windows Azure Activity Log</em></p></li>
<li><p>You can examine the <strong>History</strong> panel on the right of the <strong>Windows Azure Activity Log</strong> window to determine the status of the deployment. Notice that the FabrikamWorker is in an <strong>unknown</strong> state.</p>

<p><img src="Images/deployment-operation-details.png?raw=true" alt="Deployment Operation Details" title="Deployment Operation Details">
</p>

<p><em>Viewing detailed information about a deployment operation</em></p></li>
<li><p>In the <strong>Windows Azure Activity Log</strong> window, click <strong>Open in Server Explorer</strong>.</p>

<p><img src="Images/cloud-service-in-server-explorer.png?raw=true" alt="Viewing the cloud service in Server Explorer" title="Viewing the cloud service in Server Explorer">
</p>

<p><em>Viewing the cloud service in Server Explorer</em></p></li>
<li><p>In the <strong>Cloud Services</strong> node, examine the role instance status of the hosted service where you deployed the <strong>FabrikamInsurance</strong> application. Notice that the label for the deployment slot indicates that IntelliTrace is enabled for this deployment and that the <strong>FabrikamWorker</strong> instance status is shown as <strong>Unknown</strong>.</p>

<p><img src="Images/service-instance-busy.png?raw=true" alt="Fabrikam Insurance Service Instance" title="Fabrikam Insurance Service Instance">
</p>

<p><em>Fabrikam Insurance Service Instance</em></p></li>
</ol>

<p><a name="Ex3Task2" /></p>

<h4>Task 2 - Examining the IntelliTrace Logs to Determine the Cause of a Failure</h4>

<p>In the previous task, the role failed to start due to an unknown reason. In this task, you will use IntelliTrace to determine what caused the failure.</p>

<ol>
<li><p>In the <strong>Cloud Services</strong> node inside the <strong>Server Explorer</strong> window, select the hosted service where you deployed the <strong>FabrikamInsurance</strong> application and expand it until you find the <strong>FabrikamWorker</strong> instance.</p></li>
<li><p>Right-click the slot node labeled <strong>Instance 0 (Unknown)</strong>, and select <strong>View IntelliTrace logs</strong> to download the information to your workstation. After you do this, notice that Visual Studio creates a new IntelliTrace entry in the <strong>Windows Azure Activity Log</strong> window to display the progress of the download operation.</p>

<p><img src="Images/downloading-the-intellitrace-logs.png?raw=true" alt="Downloading the IntelliTrace logs" title="Downloading the IntelliTrace logs">
</p>

<p><em>Downloading the IntelliTrace logs</em></p></li>
<li><p>Wait for the download to complete (it may take several minutes). Meanwhile, you can expand the corresponding entry in the <strong>Windows Azure Activity Log</strong> window and examine the <strong>History</strong> panel on the right to monitor the progress of the operation.</p>

<p><img src="Images/intellitrace-operation-history-log.png?raw=true" alt="IntelliTrace operation history log" title="IntelliTrace operation history log">
</p>

<p><em>IntelliTrace operation history log</em></p>
<blockquote>
<p><strong>Note:</strong> When you request the IntelliTrace logs, a snapshot of the information collected so far is uploaded from the VM instance where the role is running to your storage account and then downloaded to a disk file on your local computer. Once the log is transferred successfully, it is deleted from the storage account.</p>
</blockquote></li>
<li><p>After the download completes, Visual Studio automatically opens the IntelliTrace log file and displays it in a window. The <strong>IntelliTrace Summary</strong> window is divided into several sections that contain diagnostics information collected for the deployment.</p>

<p><img src="Images/intellitrace-summary-window.png?raw=true" alt="IntelliTrace summary window" title="IntelliTrace summary window">
</p>

<p><em>IntelliTrace Summary window</em></p>

<p>The following sections can be found in the IntelliTrace summary window:</p>

<p><strong>Exception Data:</strong> lists unhandled exceptions that occurred during the data collection period, including details about the exception type, exception message, number of exceptions of that kind that were raised, and the time of the newest exception. Selecting an entry in the list displays the corresponding call stack for the exception.</p>

<p>If an exception occurs in your code, you can select the exception in the list and then click <strong>Debug Newest Exception in Group</strong> to open the appropriate source file in Visual Studio with the cursor placed on the line of code that raised the exception.</p>

<p><img src="Images/exception-data-section.png?raw=true" alt="Exception Data section" title="Exception Data section">
</p>

<p><em>Exception Data section</em></p>

<p><strong>System Info:</strong> shows information about the virtual machine environment where the diagnostics data was collected, including the computer name, operating system and CLR versions, physical memory and virtual memory available, number of processors, and time zone, among other details.</p>

<p><img src="Images/system-info-section.png?raw=true" alt="System Info section" title="System Info section">
</p>

<p><em>System Info section</em></p>

<p><strong>Threads List:</strong> shows every active thread during the diagnostics collection period, with each thread displaying the ID, name (if available), and the start and end times.</p>

<p><img src="Images/threads-list-section.png?raw=true" alt="Threads List section" title="Threads List section">
</p>

<p><em>Threads List section</em></p>

<p><strong>Modules:</strong> lists every module loaded in memory, including the name of the module and the path from where it was loaded. This information can be useful to debug assembly-loading issues.</p>

<p><img src="Images/modules-section.png?raw=true" alt="Modules section" title="Modules section">
</p>

<p><em>Modules section</em></p>
<blockquote>
<p><strong>Note:</strong> For the current deployment, you used the default settings to define the events captured by IntelliTrace.</p>

<p>To configure which events should be included in the IntelliTrace log during the Publishing operation click <strong>Settings</strong> next to the <strong>Enable IntelliTrace</strong> check box to open the <strong>IntelliTrace Settings</strong> window.</p>

<p><img src="Images/configuring-intellitrace-settings.png?raw=true" alt="Configuring IntelliTrace settings" title="Configuring IntelliTrace settings">
</p>

<p><em>Configuring IntelliTrace settings before publishing a service package</em></p>
</blockquote></li>
<li><p>To determine what caused the role to fail during start up in the previous task, expand the <strong>Exception</strong> <strong>Data</strong> section on the summary page and examine the list of exceptions.</p>

<p><img src="Images/viewing-exception-data.png?raw=true" alt="Viewing exception data" title="Viewing exception data">
</p>

<p><em>Viewing exception data in the IntelliTrace summary window</em></p>

<p>In general, this list contains multiple exceptions, some of which may be ignored, as they are handled by the runtime environment and do not cause the role to crash. There is no precise rule regarding which exceptions are normal and can be ignored, so you will typically review the list to identify potentially fatal exceptions. </p>

<p>Notice that the list includes a <strong>FabrikamWorker.CustomException</strong> with the message &quot;<em>This is an example error.</em>&quot; This is a custom exception that was created to easily showcase IntelliTrace.</p>

<p>To fix this particular problem, just remove the statement that throws the exception inside the <strong>Run</strong> method of the <strong>WorkerRole</strong> class.</p></li>
<li><p>Select the <strong>FabrikamWorker.CustomException</strong> exception and click <strong>Debug Newest Exception in Group</strong> in order to locate where the exception is being thrown.</p>

<p><img src="Images/debugging-the-customexception.png?raw=true" alt="Debugging the CustomException" title="Debugging the CustomException">
</p>

<p><em>Debugging the CustomException</em></p></li>
<li><p>The <strong>WorkerRole.cs</strong> file should open in Debugging mode, highlighting the statement where the CustomException is thrown.</p>

<p><img src="Images/debugging-the-worker-role.png?raw=true" alt="Debugging the Worker Role" title="Debugging the Worker Role">
</p>

<p><em>Debugging the Worker Role</em></p></li>
<li><p>In the IntelliTrace window, locate the highlighted event and click <strong>Calls View</strong> in order to switch to <strong>IntelliTrace Calls View</strong>.</p>

<p><img src="Images/switching-to-the-calls-view.png?raw=true" alt="Switching to the Calls View" title="Switching to the Calls View">
</p>

<p><em>Switching to the Calls View</em></p></li>
<li><p>In <strong>IntelliTrace Calls View</strong>, click one of the calls above the highlighted entry in order to move the debugger's position to other statements.</p>

<p><img src="Images/changing-to-other-statement-using-the-intelli.png?raw=true" alt="Changing to other statement using the IntelliTrace Calls View" title="Changing to other statement using the IntelliTrace Calls View">
</p>

<p><em>Changing to other statements using the IntelliTrace Calls View</em></p></li>
<li><p>Press <strong>Shift + F5</strong> to stop debugging.</p></li>
<li><p>Cancel and remove the failing deployment to Windows Azure. To do this, in the <strong>Windows Azure Activity Log</strong> window, right-click the deployment and select <strong>Cancel and remove</strong>.</p>

<p><img src="Images/cancel-failing-deployment.png?raw=true" alt="Cancel the failing deployment" title="Cancel the failing deployment">
</p>

<p><em>Cancel the failing deployment</em></p></li>
</ol>

<hr>

<p><a name="NextSteps"></a></p>

<h2>Next Steps</h2>

<p>To learn more about debugging applications in Windows Azure, please refer to the following articles:</p>

<p><strong>Technical Reference</strong></p>

<p>This is a list of articles that expand on the technologies explained in this lab:</p>

<ul>
<li><p><a href="http://msdn.microsoft.com/en-us/library/sc65sadd.aspx">Debugging in Visual Studio</a>: extensively covers the debugging functions integrated with Visual Studio.</p></li>
<li><p><a href="http://msdn.microsoft.com/en-us/library/windowsazure/dn339018.aspx">Debugging a Cloud Service with Emulator Express</a>: explains how to test and debug a cloud service without running Visual Studio as an administrator.</p></li>
<li><p><a href="http://msdn.microsoft.com/en-us/library/windowsazure/hh411537.aspx">Initialize or Change Windows Azure Diagnostics Configuration</a>: describes the different aspects of the Diagnostic configuration, like the Diagnostics data sources, the Diagnostics Monitor settings and storage of the Diagnostics data.</p></li>
<li><p><a href="http://msdn.microsoft.com/en-us/library/windowsazure/hh411542.aspx">Create and Use Performance Counters in a Windows Azure Application</a>: shows how to use performance counters to measure the health of your Windows Azure application. You can collect data from existing performance counters or create custom performance counters to collect additional data.</p></li>
<li><p><a href="http://msdn.microsoft.com/en-us/library/t06xyy08.aspx">How to: Configure Trace Switches</a>: by placing <strong>Trace Switches</strong> in your code, you can control whether tracing occurs or not and how &lt;to what extent. This lets you monitor the status of your application in a production environment.</p></li>
<li><p><a href="http://msdn.microsoft.com/en-us/library/dd264915.aspx">Debug Your App by Recording Code Execution with IntelliTrace</a>: explains how to use IntelliTrace to record and trace your code's execution history.</p></li>
</ul>

<p><strong>Development</strong></p>

<p>This is a list of developer-oriented articles related to debugging applications in Windows Azure:</p>

<ul>
<li><p><a href="http://msdn.microsoft.com/en-us/library/windowsazure/gg432992.aspx">Remotely Change the Diagnostic Monitor Configuration</a>: after you have deployed a cloud service, you can remotely change the configuration of the diagnostic monitor from code running in an application outside of Windows Azure using the <a href="http://msdn.microsoft.com/en-us/library/windowsazure/microsoft.windowsazure.diagnostics.management.deploymentdiagnosticmanager.aspx">DeploymentDiagnosticManager</a> class.</p></li>
<li><p><a href="http://msdn.microsoft.com/en-us/library/windowsazure/hh411529.aspx">Trace the Flow of Your Windows Azure Application</a>: add tracing and debugging instrumentation to your Windows Azure application when you develop it and use that instrumentation during development and after deployment.</p></li>
<li><p><a href="http://msdn.microsoft.com/en-us/library/ee661590.aspx">API Reference for IntelliTrace Extensibility</a>: provides information to use IntelliTrace extensibility APIs to read and decode .itrace files in your application.</p></li>
</ul>

<hr>

<p><a name="Summary"></a></p>

<h2>Summary</h2>

<p>By completing this hands-on lab, you have learned how to apply simple debugging techniques to troubleshoot your Windows Azure application both locally and once you deploy to the cloud. You also saw how to use Windows Azure Tools for Visual Studio to configure Windows Azure Diagnostics.</p>

<p>Using IntelliTrace, you quickly diagnosed a role that failed to start due to an exception.</p>
